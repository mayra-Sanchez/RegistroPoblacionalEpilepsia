<!-- Controles de tabla mejorados -->
<div class="table-controls">
    <div class="table-controls-group">
        <!-- Elementos por página -->
        <div class="control-item">
            <label for="items-per-page-select">Elementos por página</label>
            <select id="items-per-page-select" class="control-select" 
                    [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
                <option *ngFor="let option of itemsPerPageOptions" [value]="option">{{ option }}</option>
            </select>
        </div>

        <!-- Filtro por operación - MEJORADO -->
        <div class="control-item" *ngIf="availableOperations.length > 0">
            <label for="operation-filter-select">Filtrar por operación</label>
            <select id="operation-filter-select" class="control-select"
                    [(ngModel)]="selectedOperation" (change)="onOperationFilterChange()">
                <option value="">Todas las operaciones</option>
                <option *ngFor="let operation of availableOperations" [value]="operation">
                    {{ getOperationLabel(operation) }}
                </option>
            </select>
        </div>
    </div>

    <!-- Búsqueda -->
    <div class="search-container">
        <label for="search-input" class="sr-only">Buscar en historial</label>
        <div class="search-wrapper">
            <input id="search-input" type="text" class="search-input"
                   [(ngModel)]="searchQuery" 
                   (keyup.enter)="onSearch()"
                   (input)="onSearch()"
                   placeholder="Buscar por paciente, usuario, variables..." />
            <div class="search-buttons">
                <button *ngIf="searchQuery" (click)="clearSearch()" class="clear-btn" 
                        aria-label="Limpiar búsqueda">
                    <i class="fa fa-times"></i>
                </button>
                <button (click)="onSearch()" class="search-btn" aria-label="Buscar">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Botón reset -->
    <button *ngIf="searchQuery || selectedOperation" (click)="resetFilters()" 
            class="reset-filters-btn">
        <i class="fa fa-refresh"></i> Limpiar Filtros
    </button>
</div>

<!-- Indicador de filtros activos -->
<div class="filter-status" *ngIf="searchQuery || selectedOperation">
    <div class="active-filters">
        <span class="filter-tag" *ngIf="searchQuery">
            Búsqueda: "{{ searchQuery }}"
            <button (click)="clearSearch()" class="remove-filter">×</button>
        </span>
        <span class="filter-tag" *ngIf="selectedOperation">
            Operación: {{ getOperationLabel(selectedOperation) }}
            <button (click)="selectedOperation = ''; onOperationFilterChange()" class="remove-filter">×</button>
        </span>
    </div>
    <div class="filter-results">
        <span>{{ filteredTotalRecords }} de {{ totalRecords }} registros</span>
    </div>
</div>

<!-- Contenedor de tabla -->
<div class="table-container" *ngIf="!loading; else loadingTemplate">
    <!-- Header informativo -->
    <div class="table-header">
        <div class="table-info">
            <span><strong>Mostrando {{ currentRange }}</strong> registros</span>
            <span class="filter-indicator" *ngIf="searchQuery || selectedOperation">
                <i class="fa fa-filter"></i> Filtros activos
            </span>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-wrapper">
        <table class="history-table">
            <thead>
                <tr>
                    <th *ngFor="let col of columns" [attr.scope]="'col'">
                        <div class="column-header">
                            <span>{{ col.header }}</span>
                        </div>
                    </th>
                    <th scope="col" width="120">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let row of paginatedData; let i = index" class="history-row">
                    <td *ngFor="let col of columns" [attr.data-label]="col.header">
                        <div [ngSwitch]="col.field">
                            <span *ngSwitchCase="'changedAt'" class="date-cell">
                                <i class="fa fa-calendar"></i>
                                {{ formatDateForDisplay(row[col.field]) }}
                            </span>
                            
                            <span *ngSwitchCase="'operation'" 
                                  [class]="'operation-badge ' + getOperationClass(row.operation)">
                                <i class="fa" 
                                   [class.fa-plus]="row.operation === 'REGISTER_CREATED_SUCCESSFULL'"
                                   [class.fa-edit]="row.operation.includes('UPDATE')"
                                   [class.fa-trash]="row.operation === 'REGISTER_DELETED'"></i>
                                {{ getOperationLabel(row.operation) }}
                            </span>
                            
                            <span *ngSwitchCase="'patientIdentificationNumber'" class="patient-cell">
                                <i class="fa fa-user"></i>
                                #{{ row[col.field] }}
                            </span>
                            
                            <span *ngSwitchCase="'changedBy'" class="user-cell">
                                <i class="fa fa-user-md"></i>
                                {{ row[col.field] }}
                            </span>
                            
                            <span *ngSwitchCase="'variables'" class="variables-cell">
                                <div *ngIf="row.isResearchLayerGroup?.variables">
                                    {{ formatVariablesForDisplay(row.isResearchLayerGroup.variables) }}
                                </div>
                                <span *ngIf="!row.isResearchLayerGroup?.variables" class="text-muted">
                                    Sin variables
                                </span>
                            </span>
                            
                            <span *ngSwitchDefault class="text-cell">
                                {{ row[col.field] || 'N/A' }}
                            </span>
                        </div>
                    </td>
                    
                    <td data-label="Acciones">
                        <div class="actions">
                            <button class="action-btn view" (click)="view(row)" title="Ver detalles">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <button class="action-btn edit" (click)="edit(row)" title="Editar">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Mensaje sin datos -->
    <div *ngIf="noData" class="no-data-message">
        <i class="fa fa-database"></i>
        <h3>{{ noDataMessage }}</h3>
        <button *ngIf="searchQuery || selectedOperation" (click)="resetFilters()" 
                class="btn-clear-all">
            Mostrar todos los registros
        </button>
    </div>
</div>

<!-- Loading template -->
<ng-template #loadingTemplate>
    <div class="loading-message">
        <i class="fa fa-spinner fa-spin"></i>
        <h3>Cargando historial...</h3>
    </div>
</ng-template>

<!-- Paginación -->
<div class="pagination-container" *ngIf="hasData">
    <div class="pagination-controls">
        <div class="pagination-info">
            <span>Página {{ currentPage }} de {{ totalPages }}</span>
            <span class="total-records">{{ filteredTotalRecords }} registros</span>
        </div>
        
        <div class="pagination-buttons">
            <button (click)="goToPage(1)" [disabled]="isFirstPage">
                <i class="fa fa-angle-double-left"></i>
            </button>
            <button (click)="prevPage()" [disabled]="isFirstPage">
                <i class="fa fa-angle-left"></i>
            </button>
            
            <div class="page-numbers">
                <button *ngFor="let page of pageNumbers" 
                        [class.active]="page === currentPage"
                        (click)="goToPage(page)">
                    {{ page }}
                </button>
            </div>
            
            <button (click)="nextPage()" [disabled]="isLastPage">
                <i class="fa fa-angle-right"></i>
            </button>
            <button (click)="goToPage(totalPages)" [disabled]="isLastPage">
                <i class="fa fa-angle-double-right"></i>
            </button>
        </div>
    </div>
</div>