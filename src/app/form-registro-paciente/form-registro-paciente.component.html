<div class="user-form-container">
    <!-- PASO 1: FORMULARIO DEL PACIENTE -->
    <form *ngIf="pasoActual === 1" [formGroup]="formPaciente" class="form-step">
        <h2 class="form-title">Datos del Paciente</h2>

        <!-- Contenido actual del formulario del paciente -->
        <div class="form-row">
            <div class="form-group">
                <label for="name">Nombre Completo</label>
                <input type="text" id="name" formControlName="name" placeholder="Nombre completo" />
                <small *ngIf="formPaciente.get('name')?.touched && formPaciente.get('name')?.invalid">
                    Este campo es obligatorio.
                </small>
            </div>

            <div class="form-group">
                <label for="identificationType">Tipo de Documento</label>
                <select formControlName="identificationType" id="identificationType">
                    <option value="" disabled selected>Seleccione un tipo de documento</option>
                    <option value="cc">Cédula de Ciudadanía</option>
                    <option value="ti">Tarjeta de Identidad</option>
                    <option value="ce">Cédula de Extranjería</option>
                    <option value="pa">Pasaporte</option>
                    <option value="rc">Registro Civil</option>
                    <option value="pep">Permiso Especial de Permanencia</option>
                    <option value="nit">Número de Identificación Tributaria (NIT)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="identificationNumber">Número de Documento</label>
                <input type="text" id="identificationNumber" formControlName="identificationNumber"
                    placeholder="Número de documento" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="sex">Sexo</label>
                <select formControlName="sex" id="sex">
                    <option value="" disabled selected>Seleccione el sexo</option>
                    <option value="femenino">Femenino</option>
                    <option value="masculino">Masculino</option>
                </select>
            </div>

            <div class="form-group">
                <label for="birthDate">Fecha de Nacimiento</label>
                <input type="date" id="birthDate" formControlName="birthDate" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <input type="email" id="email" formControlName="email" placeholder="Correo electrónico" />
            </div>

            <div class="form-group">
                <label for="phoneNumber">Número Telefónico</label>
                <input type="text" id="phoneNumber" formControlName="phoneNumber" placeholder="Número telefónico" />
            </div>
        </div>

        <!-- Campos Adicionales -->
        <div class="form-row">
            <div class="form-group">
                <label for="deathDate">Fecha de Fallecimiento</label>
                <input type="date" id="deathDate" formControlName="deathDate" />
            </div>

            <div class="form-group">
                <label for="economicStatus">Estado Económico</label>
                <select formControlName="economicStatus" id="economicStatus">
                    <option value="" disabled selected>Seleccione una opción</option>
                    <option value="uno">1</option>
                    <option value="dos">2</option>
                    <option value="tres">3</option>
                    <option value="cuatro">4</option>
                    <option value="cinco">5</option>
                    <option value="seis">6</option>
                </select>
            </div>

            <div class="form-group">
                <label for="maritalStatus">Estado Civil</label>
                <select formControlName="maritalStatus" id="maritalStatus">
                    <option value="" disabled selected>Seleccione una opción</option>
                    <option value="soltero">Soltero</option>
                    <option value="casado">Casado</option>
                    <option value="viudo">Viudo</option>
                    <option value="divorciado">Divorciado</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="hometown">Ciudad Natal</label>
                <input type="text" id="hometown" formControlName="hometown" placeholder="Ciudad de nacimiento" />
            </div>

            <div class="form-group">
                <label for="currentCity">Ciudad Actual</label>
                <input type="text" id="currentCity" formControlName="currentCity" placeholder="Ciudad actual" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="firstCrisisDate">Fecha de Primera Crisis</label>
                <input type="date" id="firstCrisisDate" formControlName="firstCrisisDate" />
                <small
                    *ngIf="formPaciente.get('firstCrisisDate')?.touched && formPaciente.get('firstCrisisDate')?.invalid">
                    Este campo es obligatorio.
                </small>
            </div>

            <div class="form-group">
                <label for="crisisStatus">Estado de Crisis</label>
                <input type="text" id="crisisStatus" formControlName="crisisStatus" placeholder="Estado de crisis" />
                <small *ngIf="formPaciente.get('crisisStatus')?.touched && formPaciente.get('crisisStatus')?.invalid">
                    Este campo es obligatorio.
                </small>
            </div>

            <div class="form-group checkbox-container">
                <label class="checkbox-label">
                    <input type="checkbox" formControlName="tieneCuidador" id="tieneCuidador">
                    <span class="checkmark"></span>
                    ¿El paciente tiene cuidador?
                </label>
            </div>
        </div>

        <div *ngIf="mostrarConsentimiento" class="modal">
            <div class="modal-content">
                <h2>Consentimiento Informado</h2>
                <p>Aquí va el contenido legal del consentimiento informado...</p>
                <canvas #signatureCanvas width="400" height="100" style="border:1px solid #000;"></canvas>
                <button (click)="clearSignature()" class="btn btn-secondary">Borrar Firma</button>
                <button (click)="saveSignature()" class="btn btn-primary">Aceptar y Guardar</button>
                <button (click)="mostrarConsentimiento = false" class="btn btn-danger">Cancelar</button>
            </div>
        </div>
        
        <!-- Consentimiento Informado -->
        <div class="form-group">
            <label for="consentimiento">
                <input type="checkbox" id="consentimiento" formControlName="consentimiento" /> Acepto el
                consentimiento informado
                <button type="button" class="btn btn-primary" (click)="onConsentimiento()">Ver Consentimiento
                    Informado</button>
            </label>

        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-next" (click)="onDatosClinicos()"
                [disabled]="!formPaciente.get('consentimiento')?.value">
                Siguiente <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </form>

    <!-- PASO 2: FORMULARIO CLÍNICO (SEPARADO) -->
    <form *ngIf="pasoActual === 2" [formGroup]="formClinico" class="form-step">
        <h2 class="form-title">Datos Clínicos</h2>

        <div formArrayName="variablesClinicas" class="variables-container">
            <div *ngFor="let variableGroup of variablesClinicasFormArray.controls; let i = index" [formGroupName]="i"
                class="variable-card">

                <h3>{{ variableGroup.get('variableName')?.value }}</h3>

                <div class="variable-control">
                    <ng-container [ngSwitch]="variableGroup.get('type')?.value">
                        <!-- Input numérico -->
                        <input *ngSwitchCase="'Entero'" type="number" formControlName="valor"
                            [placeholder]="'Ingrese ' + variableGroup.get('variableName')?.value">

                        <!-- Input decimal -->
                        <input *ngSwitchCase="'Decimal'" type="number" step="0.01" formControlName="valor"
                            [placeholder]="'Ingrese ' + variableGroup.get('variableName')?.value">

                        <!-- Input texto -->
                        <input *ngSwitchCase="'Texto'" type="text" formControlName="valor"
                            [placeholder]="'Ingrese ' + variableGroup.get('variableName')?.value">

                        <!-- Selector booleano -->
                        <select *ngSwitchCase="'Booleano'" formControlName="valor">
                            <option [ngValue]="null" disabled>Seleccione...</option>
                            <option [ngValue]="true">Sí</option>
                            <option [ngValue]="false">No</option>
                        </select>

                        <!-- Selector de opciones -->
                        <select *ngSwitchCase="'Opciones'" formControlName="valor">
                            <option [ngValue]="null" disabled>Seleccione...</option>
                            <option *ngFor="let opcion of variableGroup.get('options')?.value" [ngValue]="opcion">
                                {{opcion}}</option>
                        </select>

                        <!-- Selector de fecha -->
                        <input *ngSwitchCase="'Fecha'" type="date" formControlName="valor">
                    </ng-container>
                </div>

                <div *ngIf="variableGroup.get('valor')?.invalid && variableGroup.get('valor')?.touched"
                    class="error-message">
                    Campo requerido
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-prev" (click)="pasoAnterior()">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button type="button" class="btn btn-next" (click)="siguientePaso()" [disabled]="formClinico.invalid">
                Siguiente <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </form>

    <!-- PASO 3: FORMULARIO DEL CUIDADOR (SEPARADO) -->
    <form *ngIf="pasoActual === 3" [formGroup]="formCuidador" class="form-step">
        <h2 class="form-title"><i class="fas fa-hands-helping"></i> Datos del Cuidador</h2>

        <!-- Campos del cuidador (se muestran solo cuando tieneCuidador es true) -->
        <div *ngIf="formPaciente.get('tieneCuidador')?.value; else noCuidador" class="cuidador-fields">
            <form [formGroup]="formCuidador">
                <div class="form-row">
                    <div class="form-group floating">
                        <input type="text" formControlName="caregiverName" id="caregiverName" placeholder=" ">
                        <label for="caregiverName">Nombre del Cuidador</label>
                        <small
                            *ngIf="formCuidador.get('caregiverName')?.invalid && formCuidador.get('caregiverName')?.touched"
                            class="error-message">
                            Este campo es obligatorio
                        </small>
                    </div>

                    <div class="form-group floating">
                        <select formControlName="caregiverIdentificationType" id="caregiverIdentificationType">
                            <option value="" disabled selected> </option>
                            <option value="cc">Cédula de Ciudadanía</option>
                            <option value="ti">Tarjeta de Identidad</option>
                            <option value="ce">Cédula de Extranjería</option>
                        </select>
                        <label for="caregiverIdentificationType">Tipo de Documento</label>
                        <small
                            *ngIf="formCuidador.get('caregiverIdentificationType')?.invalid && formCuidador.get('caregiverIdentificationType')?.touched"
                            class="error-message">
                            Seleccione un tipo de documento
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group floating">
                        <input type="text" formControlName="caregiverIdentificationNumber"
                            id="caregiverIdentificationNumber" placeholder=" " [pattern]="'^[0-9]+$'">
                        <label for="caregiverIdentificationNumber">Número de Documento</label>
                        <small
                            *ngIf="formCuidador.get('caregiverIdentificationNumber')?.invalid && formCuidador.get('caregiverIdentificationNumber')?.touched"
                            class="error-message">
                            {{ formCuidador.get('caregiverIdentificationNumber')?.errors?.['required'] ?
                            'Este campo es obligatorio' : 'Solo se permiten números' }}
                        </small>
                    </div>

                    <div class="form-group floating">
                        <input type="number" formControlName="caregiverAge" id="caregiverAge" placeholder=" " min="1">
                        <label for="caregiverAge">Edad</label>
                        <small
                            *ngIf="formCuidador.get('caregiverAge')?.invalid && formCuidador.get('caregiverAge')?.touched"
                            class="error-message">
                            {{ formCuidador.get('caregiverAge')?.errors?.['required'] ?
                            'Este campo es obligatorio' : 'La edad mínima es 1 año' }}
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group floating">
                        <select formControlName="caregiverEducationLevel" id="caregiverEducationLevel">
                            <option value="" disabled selected> </option>
                            <option value="primaria">Primaria</option>
                            <option value="secundaria">Secundaria</option>
                            <option value="tecnico">Técnico/Tecnólogo</option>
                            <option value="universitario">Universitario</option>
                            <option value="postgrado">Postgrado</option>
                        </select>
                        <label for="caregiverEducationLevel">Nivel Educativo</label>
                    </div>

                    <div class="form-group floating">
                        <input type="text" formControlName="caregiverOccupation" id="caregiverOccupation"
                            placeholder=" ">
                        <label for="caregiverOccupation">Ocupación</label>
                    </div>
                </div>
            </form>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-prev" (click)="pasoAnterior()">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button type="button" class="btn btn-next" (click)="siguientePaso()"
                [disabled]="tieneCuidador && formCuidador.invalid">
                Siguiente <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </form>

    <!-- PASO 4: FORMULARIO DEL PROFESIONAL (SEPARADO) -->
    <form *ngIf="pasoActual === 4" [formGroup]="formProfesional" class="form-step">
        <h2 class="form-title">Datos del Profesional</h2>

        <!-- Contenido del formulario del profesional -->
        <div class="form-group">
            <label>Nombre del Profesional</label>
            <input type="text" formControlName="healthProfessionalName" />
        </div>
        <!-- Resto de campos del profesional... -->

        <div class="form-actions">
            <button type="button" class="btn btn-prev" (click)="pasoAnterior()">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button type="button" class="btn btn-submit" (click)="onRegister()" [disabled]="formProfesional.invalid">
                <i class="fas fa-save"></i> Guardar Registro
            </button>
        </div>
    </form>
</div>

<ng-template #noCuidador>
    <p style="color: red; font-weight: bold;">Formulario no disponible</p>
  </ng-template>