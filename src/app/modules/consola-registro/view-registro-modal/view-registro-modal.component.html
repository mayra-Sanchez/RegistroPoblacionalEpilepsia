<div class="modal-overlay">
  <div class="modal-container">
    <!-- Encabezado -->
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-user-circle"></i> Detalles Completo del Registro</h3>
      <button class="close-btn" (click)="closeModal()">
        &times;
      </button>
    </div>

    <!-- Cuerpo -->
    <div class="modal-body">
      <div *ngIf="registro">
        <!-- Sección Identificación -->
        <div class="info-section">
          <h4 class="section-title">Identificación</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Tipo de Documento:</span>
              <div class="info-value">
                {{ getLabel(tiposIdentificacion, registro.patientIdentificationType) }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Número de Documento:</span>
              <div class="info-value">
                {{ registro.patientIdentificationNumber }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Datos Básicos -->
        <div class="info-section">
          <h4 class="section-title">Datos Básicos del Paciente</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Nombre Completo:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.name || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Género:</span>
              <div class="info-value">
                {{ getLabel(generos, registro.patientBasicInfo.sex) || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Edad:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.age || 'No especificada' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Contacto -->
        <div class="info-section">
          <h4 class="section-title">Información de Contacto</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Email:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.email || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Teléfono:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.phoneNumber || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Ciudad Actual:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.currentCity || 'No especificada' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Ciudad de Origen:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.hometown || 'No especificada' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Socioeconómica -->
        <div class="info-section">
          <h4 class="section-title">Datos Socioeconómicos</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Nivel Educativo:</span>
              <div class="info-value">
                {{ getLabel(nivelesEducacion, registro.patientBasicInfo.educationLevel) || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Estado Civil:</span>
              <div class="info-value">
                {{ getLabel(estadosCiviles, registro.patientBasicInfo.maritalStatus) || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Nivel Económico:</span>
              <div class="info-value">
                {{ getLabel(estadosEconomicos, registro.patientBasicInfo.economicStatus) || 'No especificado' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Estado Clínico -->
        <div class="info-section">
          <h4 class="section-title">Estado Clínico</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Fecha Primera Crisis:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.firstCrisisDate }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Estado de Crisis:</span>
              <div class="info-value">
                {{ registro.patientBasicInfo.crisisStatus || 'No especificado' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Cuidador -->
        <div class="info-section" *ngIf="registro.caregiver && hasCaregiverData(registro.caregiver)">
          <h4 class="section-title">Información del Cuidador</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Nombre del Cuidador:</span>
              <div class="info-value">
                {{ registro.caregiver.name || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Tipo de Documento:</span>
              <div class="info-value">
                {{ getLabel(tiposIdentificacion, registro.caregiver.identificationType) || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Número de Documento:</span>
              <div class="info-value">
                {{ registro.caregiver.identificationNumber || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Edad:</span>
              <div class="info-value">
                {{ registro.caregiver.age || 'No especificada' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Nivel Educativo:</span>
              <div class="info-value">
                {{ getLabel(nivelesEducacion, registro.caregiver.educationLevel) || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Ocupación:</span>
              <div class="info-value">
                {{ registro.caregiver.occupation || 'No especificada' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Profesional de Salud -->
        <div class="info-section" *ngIf="registro.healthProfessional">
          <h4 class="section-title">Profesional de Salud</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <div class="info-value">
                {{ registro.healthProfessional.name || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Número de Documento:</span>
              <div class="info-value">
                {{ registro.healthProfessional.identificationNumber || 'No especificado' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Variables de Investigación -->
        <div class="info-section" *ngIf="getCurrentLayerVariables().length > 0">
          <h4 class="section-title">Variables de Investigación</h4>
          <div class="info-grid">
            <div class="info-item" *ngFor="let variable of getCurrentLayerVariables()">
              <span class="info-label">{{ variable.variableName }}:</span>
              <div class="info-value">
                {{ formatVariableValue(variable.variableName, variable.value, variable.type) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Metadatos -->
        <div class="info-section" *ngIf="registro">
          <h4 class="section-title">Metadatos del Registro</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Fecha de Creación:</span>
              <div class="info-value">
                {{ formatVariableValue('Fecha', registro.registerDate, 'date') }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Última Modificación:</span>
              <div class="info-value">
                {{ formatVariableValue('Fecha de Modificación', registro.updateRegisterDate, 'date') }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">Modificado Por:</span>
              <div class="info-value">
                {{ registro.updatedBy || 'No especificado' }}
              </div>
            </div>

            <div class="info-item">
              <span class="info-label">ID del Registro:</span>
              <div class="info-value">
                {{ registro.registerId }}
              </div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h4 class="section-title">Documento de Consentimiento</h4>
          <div class="info-grid">
            <div class="info-item">
              <button (click)="viewConsentDocument()" [disabled]="isLoadingDocument" class="btn-document">
                <i class="fas fa-file-contract"></i>
                <span *ngIf="!isLoadingDocument">Ver Consentimiento Firmado</span>
                <span *ngIf="isLoadingDocument">Cargando documento...</span>
              </button>

              <div *ngIf="documentError" class="error-message">
                <i class="fas fa-exclamation-circle"></i> {{ documentError }}
              </div>
            </div>
          </div>
        </div>

        <!-- Modal para visualizar el documento -->
        <div *ngIf="showDocument" class="document-modal-overlay">
          <div class="document-modal">
            <div class="document-modal-header">
              <h4>Documento de Consentimiento</h4>
              <button (click)="closeDocumentView()" class="close-button">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="document-modal-body">
              <div *ngIf="isLoadingDocument" class="loading-message">
                <i class="fas fa-spinner fa-spin"></i> Cargando documento...
              </div>

              <div *ngIf="!isLoadingDocument && documentUrl">
                <iframe *ngIf="documentType === 'pdf'" [src]="documentUrl" width="100%" height="500px" frameborder="0"
                  style="border: none;">
                </iframe>

                <img *ngIf="documentType === 'image'" [src]="documentUrl" alt="Documento de consentimiento"
                  class="document-image">

                <div *ngIf="documentType === 'unknown'" class="unsupported-document">
                  <p><i class="fas fa-exclamation-triangle"></i> Formato de documento no soportado para vista previa</p>
                  <a [href]="documentUrl" download="consentimiento.pdf" class="download-link">
                    <i class="fas fa-download"></i> Descargar documento
                  </a>
                </div>
              </div>

              <div *ngIf="!isLoadingDocument && !documentUrl && documentError" class="error-message">
                <i class="fas fa-exclamation-circle"></i> {{ documentError }}
              </div>
            </div>
          </div>
        </div>
        <!-- Modal para subir documento -->
        <div *ngIf="showUploadModal" class="upload-modal-overlay">
          <div class="upload-modal">
            <div class="upload-modal-header">
              <h4>Subir Documento de Consentimiento</h4>
              <button (click)="closeUploadModal()" class="close-button">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="upload-modal-body">
              <div class="file-upload-container">
                <label for="consentFileInput" class="file-upload-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span *ngIf="!selectedFile">Seleccionar archivo (PDF o imagen)</span>
                  <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
                  <input id="consentFileInput" type="file" (change)="onFileSelected($event)"
                    accept=".pdf,.jpg,.jpeg,.png" hidden>
                </label>

                <div *ngIf="selectedFile" class="file-actions">
                  <button (click)="clearFileSelection()" class="btn-clear">
                    <i class="fas fa-times"></i> Cambiar archivo
                  </button>
                </div>
              </div>

              <div class="upload-actions">
                <button (click)="closeUploadModal()" class="btn-cancel">Cancelar</button>
                <button (click)="uploadConsent()" class="btn-upload" [disabled]="!selectedFile || isUploading">
                  <span *ngIf="!isUploading">
                    <i class="fas fa-upload"></i> Subir Documento
                  </span>
                  <span *ngIf="isUploading">
                    <i class="fas fa-spinner fa-spin"></i> Subiendo...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay documento -->
        <div *ngIf="documentError === 'El paciente no tiene documento de consentimiento registrado'"
          class="no-document-message">
          <div class="message-content">
            <i class="fas fa-file-exclamation"></i>
            <p>El paciente no tiene documento de consentimiento registrado</p>
            <button (click)="openUploadModal()" class="btn-upload">
              <i class="fas fa-upload"></i> Subir Documento
            </button>
          </div>
        </div>
        <!-- Pie -->
        <div class="modal-footer">
          <button class="btn-close" (click)="closeModal()">
            Cerrar Detalles
          </button>
        </div>
      </div>
    </div>
  </div>
</div>