<div class="container">
  <h1>Visualización de Registros Médicos</h1>
  
  <!-- Sección de Filtros -->
  <div class="filters-section">
    <h2>Filtros</h2>
    
    <div class="filter-row">
      <!-- Filtro por nombre de paciente -->
      <mat-form-field appearance="fill">
        <mat-label>Nombre del paciente</mat-label>
        <input matInput [(ngModel)]="filters.patientName" (input)="applyFilters()">
      </mat-form-field>
      
      <!-- Filtro por variable -->
      <mat-form-field appearance="fill">
        <mat-label>Variable médica</mat-label>
        <input matInput [(ngModel)]="filters.variableName" (input)="applyFilters()">
      </mat-form-field>
      
      <!-- Filtro por sexo -->
      <mat-form-field appearance="fill">
        <mat-label>Sexo</mat-label>
        <mat-select [(ngModel)]="filters.sex" (selectionChange)="applyFilters()">
          <mat-option value="">Todos</mat-option>
          <mat-option value="Masculino">Masculino</mat-option>
          <mat-option value="Femenino">Femenino</mat-option>
          <mat-option value="Otro">Otro</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    
    <div class="filter-row">
      <!-- Filtro por edad -->
      <mat-form-field appearance="fill">
        <mat-label>Edad mínima</mat-label>
        <input matInput type="number" [(ngModel)]="filters.minAge" (change)="applyFilters()">
      </mat-form-field>
      
      <mat-form-field appearance="fill">
        <mat-label>Edad máxima</mat-label>
        <input matInput type="number" [(ngModel)]="filters.maxAge" (change)="applyFilters()">
      </mat-form-field>
      
      <!-- Filtro por estado de crisis -->
      <mat-form-field appearance="fill">
        <mat-label>Estado de crisis</mat-label>
        <mat-select [(ngModel)]="filters.crisisStatus" (selectionChange)="applyFilters()">
          <mat-option value="">Todos</mat-option>
          <mat-option value="Activo">Activo</mat-option>
          <mat-option value="Inactivo">Inactivo</mat-option>
          <mat-option value="Remisión">Remisión</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    
    <div class="filter-row">
      
      <!-- Filtro por rango de fechas -->
      <mat-form-field appearance="fill">
        <mat-label>Rango de fechas</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate [(ngModel)]="filters.dateRange.start" (dateChange)="applyFilters()" placeholder="Inicio">
          <input matEndDate [(ngModel)]="filters.dateRange.end" (dateChange)="applyFilters()" placeholder="Fin">
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
      
      <button mat-raised-button color="warn" (click)="resetFilters()">
        <mat-icon>refresh</mat-icon> Resetear Filtros
      </button>
    </div>
  </div>
  
  <!-- Selector de vista -->
  <div class="view-options">
    <button mat-raised-button 
            (click)="viewType = 'chart'; prepareVisualizationData()" 
            [color]="viewType === 'chart' ? 'primary' : ''">
      <mat-icon>bar_chart</mat-icon> Gráficos
    </button>
    <button mat-raised-button 
            (click)="viewType = 'table'" 
            [color]="viewType === 'table' ? 'primary' : ''">
      <mat-icon>table_chart</mat-icon> Tabla
    </button>
  </div>
  
  <!-- Visualización de datos -->
  <div class="visualization-container">
    <ng-container *ngIf="viewType === 'chart'">
      <div class="chart-options">
        <button mat-button (click)="chartType = 'bar'; prepareVisualizationData()">Barras</button>
        <button mat-button (click)="chartType = 'pie'; prepareVisualizationData()">Pastel</button>
        <button mat-button (click)="chartType = 'line'; prepareVisualizationData()">Líneas</button>
      </div>
      
      <div *ngIf="filteredRegisters.length > 0; else noData" class="chart-wrapper">
        <canvas baseChart
                [type]="chartType"
                [data]="chartData"
                [options]="chartOptions">
        </canvas>
      </div>
      <ng-template #noData>
        <p class="no-data-message">No hay registros que coincidan con los filtros aplicados.</p>
      </ng-template>
    </ng-container>
    
    <ng-container *ngIf="viewType === 'table'">
      <div class="table-responsive">
        <table mat-table [dataSource]="filteredRegisters" class="mat-elevation-z8">
          <!-- Columnas de la tabla -->
          <ng-container matColumnDef="patientName">
            <th mat-header-cell *matHeaderCellDef>Paciente</th>
            <td mat-cell *matCellDef="let reg">{{reg.patientBasicInfo?.name || 'N/A'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="sex">
            <th mat-header-cell *matHeaderCellDef>Sexo</th>
            <td mat-cell *matCellDef="let reg">{{reg.patientBasicInfo?.sex || 'N/A'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="age">
            <th mat-header-cell *matHeaderCellDef>Edad</th>
            <td mat-cell *matCellDef="let reg">{{reg.patientBasicInfo?.age || 'N/A'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="crisisStatus">
            <th mat-header-cell *matHeaderCellDef>Estado crisis</th>
            <td mat-cell *matCellDef="let reg">{{reg.patientBasicInfo?.crisisStatus || 'N/A'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="registerDate">
            <th mat-header-cell *matHeaderCellDef>Fecha registro</th>
            <td mat-cell *matCellDef="let reg">{{reg.registerDate | date:'short'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="variables">
            <th mat-header-cell *matHeaderCellDef>Variables</th>
            <td mat-cell *matCellDef="let reg">
              <mat-chip-listbox>
                <mat-chip *ngFor="let variable of reg.variablesRegister" [title]="variable.variableName">
                  {{variable.variableName | truncate:15}}
                </mat-chip>
              </mat-chip-listbox>
            </td>
          </ng-container>
          
          <tr mat-header-row *matHeaderRowDef="['patientName', 'sex', 'age', 'crisisStatus', 'registerDate', 'variables']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['patientName', 'sex', 'age', 'crisisStatus', 'registerDate', 'variables'];"></tr>
        </table>
        
        <mat-paginator [length]="totalElements"
                      [pageSize]="pageSize"
                      [pageIndex]="currentPage"
                      (page)="changePage($event.pageIndex)"
                      showFirstLastButtons
                      [pageSizeOptions]="[5, 10, 25, 100]">
        </mat-paginator>
      </div>
    </ng-container>
  </div>
</div>