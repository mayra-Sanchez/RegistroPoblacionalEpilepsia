<!-- registro-paciente.component.html -->
<div class="registro-paciente-container">
    <div class="header">
        <h2><i class="fas fa-user-plus"></i> Nuevo Registro de Paciente</h2>
        <p class="layer-info">Capa: {{ researchLayerName }}</p>
    </div>

    <!-- Loading state for variables -->
    <div *ngIf="loadingVariables" class="loading-variables">
        <i class="fas fa-spinner fa-spin"></i>
        Cargando variables de la capa...
    </div>

    <!-- Navegación por secciones -->
    <div class="section-navigation" *ngIf="!loadingVariables">
        <div class="nav-buttons">
            <button class="nav-btn" (click)="changeSection(0)" [class.active]="currentSection === 0">
                <span class="step-number">1</span>
                Identificación
            </button>
            <button class="nav-btn" (click)="changeSection(1)" [class.active]="currentSection === 1">
                <span class="step-number">2</span>
                Información Personal
            </button>
            <button class="nav-btn" (click)="changeSection(2)" [class.active]="currentSection === 2">
                <span class="step-number">3</span>
                Información Adicional
            </button>
            <!-- Nueva sección para consentimiento -->
            <button class="nav-btn" (click)="changeSection(3)" [class.active]="currentSection === 3">
                <span class="step-number">4</span>
                Consentimiento
            </button>
            <button class="nav-btn" (click)="changeSection(4)" [class.active]="currentSection === 4">
                <span class="step-number">5</span>
                Cuidador
            </button>
            <button class="nav-btn" (click)="changeSection(5)" [class.active]="currentSection === 5"
                *ngIf="variables.length > 0">
                <span class="step-number">6</span>
                Variables
            </button>
        </div>

        <div class="progress-bar">
            <div class="progress" [style.width]="((currentSection + 1) / (variables.length > 0 ? 6 : 5)) * 100 + '%'">
            </div>
        </div>
    </div>

    <!-- FORMULARIO -->
    <form [formGroup]="registroForm" (ngSubmit)="onSubmit()" class="registro-form" *ngIf="!loadingVariables">
        <!-- Sección: Identificación -->
        <div class="form-section" [class.active]="currentSection === 0">
            <h3><i class="fas fa-id-card"></i> Identificación</h3>

            <!-- Indicador de estado de validación -->
            <div class="validation-status-indicator" *ngIf="!validationFlag">
                <div class="validation-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Debe validar el paciente para continuar</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Tipo de Identificación *</label>
                    <select formControlName="patientIdentificationType">
                        <option *ngFor="let tipo of tiposIdentificacion" [value]="tipo.value">
                            {{ tipo.label }}
                        </option>
                    </select>
                </div>

                <div class="form-group identificacion-con-boton">
                    <label>Número de Identificación *</label>
                    <div class="input-with-button">
                        <input type="text" formControlName="patientIdentificationNumber" placeholder="Ej: 1234567890"
                            [class.not-validated]="!validationFlag" />
                        <button type="button" class="btn btn-validate" (click)="validarPaciente()"
                            [disabled]="validatingPatient">
                            <i class="fas" [class.fa-search]="!validatingPatient" [class.fa-spinner]="validatingPatient"
                                [class.fa-spin]="validatingPatient"></i>
                            {{ validatingPatient ? 'Validando...' : 'Validar' }}
                        </button>
                    </div>

                    <div *ngIf="registroForm.get('patientIdentificationNumber')?.invalid && 
                  registroForm.get('patientIdentificationNumber')?.touched" class="error-message">
                        Número de identificación requerido
                    </div>

                    <!-- Mensaje de validación -->
                    <div *ngIf="validationMessage" class="validation-message" [ngClass]="validationStatus">
                        <i class="fas" [ngClass]="{
          'fa-check-circle': validationStatus === 'success',
          'fa-exclamation-circle': validationStatus === 'warning',
          'fa-times-circle': validationStatus === 'error'
        }"></i>
                        {{ validationMessage }}
                    </div>

                    <!-- Indicador de próximo paso -->
                    <div *ngIf="validationFlag" class="next-step-indicator">
                        <i class="fas fa-check-circle"></i>
                        <span>Paciente validado. Puede continuar con el registro.</span>
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Información Personal -->
        <div class="form-section" [class.active]="currentSection === 1">
            <h3><i class="fas fa-user"></i> Información Personal</h3>
            <div formGroupName="patient">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" formControlName="name" placeholder="Nombre completo" appCapitalize />
                        <div *ngIf="registroForm.get('patient')?.get('name')?.invalid && registroForm.get('patient')?.get('name')?.touched"
                            class="error-message">
                            Nombre es requerido
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Sexo *</label>
                        <select formControlName="sex">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let sexo of sexos" [value]="sexo.value">
                                {{ sexo.label }}
                            </option>
                        </select>
                        <div *ngIf="registroForm.get('patient')?.get('sex')?.invalid && registroForm.get('patient')?.get('sex')?.touched"
                            class="error-message">
                            Sexo es requerido
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Nacimiento *</label>
                        <input type="date" formControlName="birthDate" (change)="onBirthDateChange()" />
                        <div *ngIf="
                  registroForm.get('patient')?.get('birthDate')?.invalid &&
                  registroForm.get('patient')?.get('birthDate')?.touched
                " class="error-message">
                            Fecha de nacimiento es requerida
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Edad</label>
                        <input type="text" formControlName="age" readonly />
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Información Adicional -->
        <div class="form-section" [class.active]="currentSection === 2">
            <h3><i class="fas fa-info-circle"></i> Información Adicional</h3>
            <div formGroupName="patient">
                <div class="form-row">
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" formControlName="phoneNumber" placeholder="Ej: 3201234567" />
                    </div>

                    <div class="form-group">
                        <label>Correo Electrónico</label>
                        <input type="email" formControlName="email" placeholder="correo@ejemplo.com" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nivel Económico</label>
                        <select formControlName="economicStatus">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let nivel of nivelesEconomicos" [value]="nivel.value">
                                {{ nivel.label }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nivel de Educación</label>
                        <select formControlName="educationLevel">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let nivel of nivelesEducacion" [value]="nivel.value">
                                {{ nivel.label }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Estado Civil</label>
                        <select formControlName="maritalStatus">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let estado of estadosCiviles" [value]="estado.value">
                                {{ estado.label }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Estado de Crisis</label>
                        <select formControlName="crisisStatus">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let estado of estadosCrisis" [value]="estado.value">
                                {{ estado.label }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad de Origen</label>
                        <input type="text" formControlName="hometown" placeholder="Ciudad de origen" />
                    </div>

                    <div class="form-group">
                        <label>Ciudad Actual</label>
                        <input type="text" formControlName="currentCity" placeholder="Ciudad actual" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Primera Crisis</label>
                        <input type="date" formControlName="firstCrisisDate" />
                    </div>

                    <div class="form-group">
                        <label>Fecha de Fallecimiento</label>
                        <input type="date" formControlName="deathDate" />
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Consentimiento -->
        <div class="form-section" [class.active]="currentSection === 3">
            <h3><i class="fas fa-file-signature"></i> Consentimiento Informado</h3>

            <div class="consentimiento-section">
                <div class="form-group">
                    <label>¿Requiere consentimiento informado? *</label>
                    <label class="switch">
                        <input type="checkbox" formControlName="hasConsentimiento"
                            (change)="onConsentimientoToggle()" />
                        <span class="slider round"></span>
                        <span class="switch-label">
                            {{ registroForm.get('hasConsentimiento')?.value ? 'Sí' : 'No' }}
                        </span>
                    </label>
                </div>

                <div *ngIf="registroForm.get('hasConsentimiento')?.value" class="file-upload-section">

                    <!-- Consentimiento Existente -->
                    <div *ngIf="existingConsentimientoUrl && !consentimientoFile" class="existing-consentimiento">
                        <div class="existing-file-header">
                            <i class="fas fa-file-pdf"></i>
                            <h4>Consentimiento Existente</h4>
                            <span class="existing-badge">Previamente subido</span>
                        </div>

                        <div class="existing-file-actions">
                            <button type="button" class="btn btn-view" (click)="viewExistingConsentimiento()">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button type="button" class="btn btn-download" (click)="downloadExistingConsentimiento()">
                                <i class="fas fa-download"></i> Descargar
                            </button>
                            <button type="button" class="btn btn-replace" (click)="fileInput.click()">
                                <i class="fas fa-sync"></i> Reemplazar
                            </button>
                        </div>

                        <div class="existing-file-note">
                            <i class="fas fa-info-circle"></i>
                            <span>Este paciente ya tiene un consentimiento subido. Puede visualizarlo, descargarlo o
                                reemplazarlo con uno nuevo.</span>
                        </div>
                    </div>

                    <!-- Carga de Nuevo Archivo -->
                    <div class="form-group">
                        <label>
                            {{ existingConsentimientoUrl ? 'Subir nuevo consentimiento informado' : 'Subir
                            consentimiento informado' }} *
                        </label>
                        <div class="file-upload-container"
                            [class.has-file]="consentimientoFile || existingConsentimientoUrl"
                            [class.has-existing]="existingConsentimientoUrl && !consentimientoFile">

                            <input type="file" #fileInput (change)="onNewFileSelected($event)"
                                accept=".pdf,.jpg,.jpeg,.png" hidden>

                            <div class="upload-area" (click)="fileInput.click()" [class.drag-over]="isDraggingOver"
                                (dragover)="onDragOver($event)" (dragleave)="onDragLeave()" (drop)="onDrop($event)">

                                <div *ngIf="loadingExistingConsentimiento" class="loading-consentimiento">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Verificando consentimiento existente...</p>
                                </div>

                                <div *ngIf="!loadingExistingConsentimiento">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>
                                        {{ existingConsentimientoUrl ?
                                        'Haga clic o arrastre un nuevo archivo para reemplazar' :
                                        'Haga clic o arrastre el archivo aquí' }}
                                    </p>
                                    <small>Formatos permitidos: PDF, JPG, PNG (Máx. 5MB)</small>
                                </div>
                            </div>

                            <!-- Preview del nuevo archivo subido -->
                            <div *ngIf="consentimientoFile" class="file-preview">
                                <div class="file-info">
                                    <i class="fas fa-file-pdf"
                                        *ngIf="consentimientoFile.type === 'application/pdf'"></i>
                                    <i class="fas fa-file-image" *ngIf="consentimientoFile.type.includes('image')"></i>
                                    <span class="file-name">{{ consentimientoFile.name }}</span>
                                    <span class="file-size">({{ getFileSize(consentimientoFile.size) }})</span>
                                    <span class="file-status new">Nuevo</span>
                                </div>
                                <button type="button" class="btn-remove" (click)="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                        </div>

                        <div *ngIf="consentimientoSubido && consentimientoFile" class="success-message">
                            <i class="fas fa-check-circle"></i> Nuevo consentimiento listo para guardar
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Cuidador -->
        <div class="form-section" [class.active]="currentSection === 4">
            <h3>
                <i class="fas fa-hands-helping"></i> Cuidador
                <label class="switch">
                    <input type="checkbox" [checked]="hasCaregiver" (change)="toggleCaregiver()"
                        [attr.data-has-data]="hasCaregiverData(registroForm.get('caregiver')?.value)" />
                    <span class="slider round"></span>
                </label>
                <span class="caregiver-status" *ngIf="hasCaregiver">
                    <i class="fas fa-check-circle"></i>
                    <span *ngIf="hasCaregiverData(registroForm.get('caregiver')?.value)">
                        Cuidador con datos completos
                    </span>
                    <span *ngIf="!hasCaregiverData(registroForm.get('caregiver')?.value)">
                        Cuidador activado - Complete los datos
                    </span>
                </span>
            </h3>

            <!-- Indicador cuando hay datos de cuidador pero el switch está off -->
            <div *ngIf="!hasCaregiver && hasCaregiverData(registroForm.get('caregiver')?.value)"
                class="caregiver-data-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Existen datos de cuidador guardados. Active el switch para visualizarlos.</span>
                <button type="button" class="btn-activate-caregiver" (click)="toggleCaregiver()">
                    <i class="fas fa-toggle-on"></i> Activar cuidador
                </button>
            </div>

            <div *ngIf="hasCaregiver" class="caregiver-section" formGroupName="caregiver">

                <!-- Indicador de origen de datos -->
                <div *ngIf="hasCaregiverData(registroForm.get('caregiver')?.value)" class="data-origin-indicator">
                    <i class="fas fa-database"></i>
                    <span>Datos cargados desde el sistema</span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Cuidador</label>
                        <input type="text" formControlName="name" placeholder="Nombre completo" appCapitalize />
                        <div class="field-status" *ngIf="registroForm.get('caregiver.name')?.value">
                            <i class="fas fa-check"></i> Completado
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tipo de Identificación</label>
                        <select formControlName="identificationType">
                            <option *ngFor="let tipo of tiposIdentificacion" [value]="tipo.value">
                                {{ tipo.label }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Número de Identificación</label>
                        <input type="text" formControlName="identificationNumber" placeholder="Ej: 987654321" />
                        <div class="field-status" *ngIf="registroForm.get('caregiver.identificationNumber')?.value">
                            <i class="fas fa-check"></i> Completado
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Edad</label>
                        <input type="number" formControlName="age" placeholder="Edad" />
                        <div class="field-status" *ngIf="registroForm.get('caregiver.age')?.value">
                            <i class="fas fa-check"></i> Completado
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nivel de Educación</label>
                        <select formControlName="educationLevel">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let nivel of nivelesEducacion" [value]="nivel.value">
                                {{ nivel.label }}
                            </option>
                        </select>
                        <div class="field-status" *ngIf="registroForm.get('caregiver.educationLevel')?.value">
                            <i class="fas fa-check"></i> Completado
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ocupación</label>
                        <select formControlName="occupation">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let ocupacion of ocupaciones" [value]="ocupacion">
                                {{ ocupacion }}
                            </option>
                        </select>
                        <div class="field-status" *ngIf="registroForm.get('caregiver.occupation')?.value">
                            <i class="fas fa-check"></i> Completado
                        </div>
                    </div>
                </div>

                <!-- Resumen del cuidador -->
                <div *ngIf="hasCaregiverData(registroForm.get('caregiver')?.value)" class="caregiver-summary">
                    <h4><i class="fas fa-user-check"></i> Resumen del Cuidador</h4>
                    <div class="summary-grid">
                        <div class="summary-item" *ngIf="registroForm.get('caregiver.name')?.value">
                            <strong>Nombre:</strong> {{ registroForm.get('caregiver.name')?.value }}
                        </div>
                        <div class="summary-item" *ngIf="registroForm.get('caregiver.identificationNumber')?.value">
                            <strong>Identificación:</strong>
                            {{ registroForm.get('caregiver.identificationNumber')?.value }}
                            ({{ registroForm.get('caregiver.identificationType')?.value }})
                        </div>
                        <div class="summary-item" *ngIf="registroForm.get('caregiver.age')?.value">
                            <strong>Edad:</strong> {{ registroForm.get('caregiver.age')?.value }} años
                        </div>
                        <div class="summary-item" *ngIf="registroForm.get('caregiver.educationLevel')?.value">
                            <strong>Educación:</strong> {{ registroForm.get('caregiver.educationLevel')?.value }}
                        </div>
                        <div class="summary-item" *ngIf="registroForm.get('caregiver.occupation')?.value">
                            <strong>Ocupación:</strong> {{ registroForm.get('caregiver.occupation')?.value }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()" [disabled]="variables.length === 0">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Variables -->
        <div class="form-section" [class.active]="currentSection === 5" *ngIf="variables.length > 0">
            <h3><i class="fas fa-list"></i> Variables de la Capa</h3>

            <!-- Controles de filtro y progreso -->
            <div class="variables-controls">
                <div class="filter-controls">
                    <label for="filterSelect">Filtrar:</label>
                    <select id="filterSelect" [(ngModel)]="currentFilter" [ngModelOptions]="{standalone: true}"
                        class="filter-select">
                        <option *ngFor="let filter of filterOptions" [value]="filter.value">
                            {{ filter.label }}
                        </option>
                    </select>
                </div>

                <div class="progress-info">
                    <span>
                        <i class="fas fa-check-circle"></i>
                        {{ completedCount }} / {{ totalCount }} completadas
                    </span>
                    <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="(completedCount / totalCount) * 100"></div>
                    </div>
                </div>
            </div>

            <!-- Variables -->
            <div class="variables-container" formArrayName="variables">
                <div *ngFor="let variable of getFilteredVariables(); let i = index" [formGroup]="variable"
                    class="variable-field" [class.completed]="isCompleted(variable)">

                    <!-- Encabezado de la variable -->
                    <label class="variable-title">
                        <span class="variable-name">
                            {{ variable.get('variableName')?.value }}
                            <span *ngIf="variable.get('isRequired')?.value" class="required-asterisk">*</span>
                        </span>

                        <!-- Badges -->
                        <span *ngIf="variable.get('hasOptions')?.value" class="options-badge">
                            <i class="fas fa-list"></i> Con Opciones
                        </span>
                        <span class="variable-type-badge" [attr.data-type]="variable.get('type')?.value">
                            {{ getTypeLabel(variable.get('type')?.value) }}
                        </span>
                    </label>

                    <!-- Descripción -->
                    <div *ngIf="variable.get('description')?.value" class="variable-description">
                        {{ variable.get('description')?.value }}
                    </div>

                    <!-- VARIABLES CON OPCIONES -->
                    <ng-container *ngIf="variable.get('hasOptions')?.value">
                        <!-- Selector tipo selección -->
                        <div class="selection-type-selector" *ngIf="variable.get('options')?.value?.length > 0">
                            <label>Tipo de selección:</label>
                            <select [value]="variable.get('selectionType')?.value"
                                (change)="onSelectionTypeChange(variable, $event)" class="selection-type-select">
                                <option *ngFor="let selType of selectionTypes" [value]="selType.value">
                                    {{ selType.label }}
                                </option>
                            </select>
                        </div>

                        <!-- Selección única -->
                        <div *ngIf="variable.get('selectionType')?.value === 'single'" class="single-selection">
                            <select formControlName="value" class="form-control">
                                <option value="">Seleccionar una opción</option>
                                <option *ngFor="let option of variable.get('options')?.value" [value]="option">
                                    {{ option }}
                                </option>
                            </select>
                        </div>

                        <!-- Selección múltiple -->
                        <div *ngIf="variable.get('selectionType')?.value === 'multiple'" class="multiple-selection">
                            <div class="options-grid">
                                <label *ngFor="let option of variable.get('options')?.value"
                                    class="option-checkbox-label">
                                    <input type="checkbox" [checked]="isOptionSelected(variable, option)"
                                        (change)="onMultipleSelectionChange(variable, option, $event)"
                                        class="option-checkbox" />
                                    <span class="checkmark"></span>
                                    <span class="option-text">{{ option }}</span>
                                </label>
                            </div>

                            <!-- Opciones seleccionadas -->
                            <div *ngIf="variable.get('value')?.value?.length > 0" class="selected-options">
                                <strong>Seleccionadas:</strong>
                                <div class="selected-tags">
                                    <span *ngFor="let selected of variable.get('value')?.value" class="selected-tag">
                                        {{ selected }} <i class="fas fa-check"></i>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Sin opciones -->
                        <div *ngIf="!variable.get('options')?.value?.length" class="no-options-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            Esta variable está configurada con opciones, pero no tiene ninguna definida.
                        </div>
                    </ng-container>

                    <!-- VARIABLES SIN OPCIONES -->
                    <ng-container *ngIf="!variable.get('hasOptions')?.value">
                        <!-- Entero -->
                        <div *ngIf="variable.get('type')?.value === 'Entero'" class="input-container">
                            <input type="number" formControlName="value" step="1" placeholder="Ej: 1, 2, 3"
                                (keypress)="validateNumber($event)" class="form-control" />
                            <i class="fas fa-hashtag input-icon"></i>
                        </div>

                        <!-- Real -->
                        <div *ngIf="variable.get('type')?.value === 'Real'" class="input-container">
                            <input type="number" formControlName="value" step="0.01" placeholder="Ej: 1.5, 2.75, 3.14"
                                (keypress)="validateDecimal($event)" class="form-control" />
                            <i class="fas fa-divide input-icon"></i>
                        </div>

                        <!-- Texto -->
                        <div *ngIf="variable.get('type')?.value === 'Texto'" class="input-container">
                            <textarea formControlName="value" rows="3" placeholder="Ej: Juan, Azul"
                                class="form-control"></textarea>
                            <i class="fas fa-font input-icon"></i>
                        </div>

                        <!-- Fecha -->
                        <div *ngIf="variable.get('type')?.value === 'Fecha'" class="input-container">
                            <input type="date" formControlName="value" class="form-control" />
                            <i class="fas fa-calendar-alt input-icon"></i>
                        </div>

                        <!-- Lógico -->
                        <div *ngIf="variable.get('type')?.value === 'Lógico'" class="checkbox-container">
                            <label class="checkbox-label large">
                                <input type="checkbox" formControlName="value"
                                    (change)="onCheckboxChange(variable, $event)" class="checkbox-input" />
                                <span class="checkmark"></span>
                                <span class="checkbox-text">{{ variable.get('value')?.value ? 'Sí' : 'No' }}</span>
                            </label>
                            <i class="fas fa-check-double input-icon"></i>
                        </div>
                    </ng-container>

                    <!-- Error -->
                    <div *ngIf="variable.get('value')?.invalid && variable.get('value')?.touched" class="error-message">
                        {{ getErrorMessage(variable) }}
                    </div>

                    <!-- Texto de ayuda -->
                    <div *ngIf="variable.get('value')?.valid && variable.get('value')?.value" class="help-text">
                        {{ getTypeDescription(variable.get('type')?.value) }}
                    </div>
                </div>
            </div>

            <!-- Navegación -->
            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
            </div>
        </div>

    </form>

    <!-- Botones de acción globales -->
    <div class="form-actions" *ngIf="!loadingVariables">
        <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="loading">
            <i class="fas fa-times"></i> Cancelar
        </button>

        <!-- Botón con tooltip cuando está deshabilitado -->
        <div class="submit-button-container" [class.disabled]="registroForm.invalid">
            <button type="submit" class="btn btn-submit" [disabled]="loading || registroForm.invalid"
                (click)="onSubmit()" #submitButton>
                <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <i *ngIf="!loading" class="fas fa-save"></i>
                {{ loading ? 'Guardando...' : 'Guardar Registro' }}
            </button>

            <!-- Tooltip que aparece cuando el formulario es inválido -->
            <div class="tooltip" *ngIf="registroForm.invalid && !loading">
                Complete todos los campos requeridos antes de guardar
            </div>
        </div>
    </div>
</div>