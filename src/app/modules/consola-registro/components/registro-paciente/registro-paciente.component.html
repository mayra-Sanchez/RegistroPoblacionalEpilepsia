<!-- registro-paciente.component.html -->
<div class="registro-paciente-container">
    <div class="header">
        <h2><i class="fas fa-user-plus"></i> Nuevo Registro de Paciente</h2>
        <p class="layer-info">Capa: {{ researchLayerName }}</p>
    </div>

    <!-- Loading state for variables -->
    <div *ngIf="loadingVariables" class="loading-variables">
        <i class="fas fa-spinner fa-spin"></i>
        Cargando variables de la capa...
    </div>

    <!-- Navegación por secciones -->
    <div class="section-navigation" *ngIf="!loadingVariables">
        <div class="nav-buttons">
            <button class="nav-btn" (click)="changeSection(0)" [class.active]="currentSection === 0">
                <span class="step-number">1</span>
                Identificación
            </button>
            <button class="nav-btn" (click)="changeSection(1)" [class.active]="currentSection === 1">
                <span class="step-number">2</span>
                Información Personal
            </button>
            <button class="nav-btn" (click)="changeSection(2)" [class.active]="currentSection === 2">
                <span class="step-number">3</span>
                Información Adicional
            </button>
            <button class="nav-btn" (click)="changeSection(3)" [class.active]="currentSection === 3">
                <span class="step-number">4</span>
                Cuidador
            </button>
            <button class="nav-btn" (click)="changeSection(4)" [class.active]="currentSection === 4"
                *ngIf="variables.length > 0">
                <span class="step-number">5</span>
                Variables
            </button>
        </div>

        <div class="progress-bar">
            <div class="progress" [style.width]="(currentSection / (variables.length > 0 ? 4 : 3)) * 100 + '%'"></div>
        </div>
    </div>

    <!-- FORMULARIO -->
    <form [formGroup]="registroForm" (ngSubmit)="onSubmit()" class="registro-form" *ngIf="!loadingVariables">
        <!-- Sección: Identificación -->
        <div class="form-section" [class.active]="currentSection === 0">
            <h3><i class="fas fa-id-card"></i> Identificación</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Tipo de Identificación *</label>
                    <select formControlName="patientIdentificationType">
                        <option *ngFor="let tipo of tiposIdentificacion" [value]="tipo.value">
                            {{ tipo.label }}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Número de Identificación *</label>
                    <input type="text" formControlName="patientIdentificationNumber" placeholder="Ej: 1234567890" />
                    <div *ngIf="
              registroForm.get('patientIdentificationNumber')?.invalid &&
              registroForm.get('patientIdentificationNumber')?.touched
            " class="error-message">
                        Número de identificación requerido
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Información Personal -->
        <div class="form-section" [class.active]="currentSection === 1">
            <h3><i class="fas fa-user"></i> Información Personal</h3>
            <div formGroupName="patient">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" formControlName="name" placeholder="Nombre completo" />
                        <div *ngIf="registroForm.get('patient')?.get('name')?.invalid && registroForm.get('patient')?.get('name')?.touched"
                            class="error-message">
                            Nombre es requerido
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Sexo *</label>
                        <select formControlName="sex">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let sexo of sexos" [value]="sexo.value">
                                {{ sexo.label }}
                            </option>
                        </select>
                        <div *ngIf="registroForm.get('patient')?.get('sex')?.invalid && registroForm.get('patient')?.get('sex')?.touched"
                            class="error-message">
                            Sexo es requerido
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Nacimiento *</label>
                        <input type="date" formControlName="birthdate" (change)="onBirthDateChange()" />
                        <div *ngIf="
                  registroForm.get('patient')?.get('birthdate')?.invalid &&
                  registroForm.get('patient')?.get('birthdate')?.touched
                " class="error-message">
                            Fecha de nacimiento es requerida
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Edad</label>
                        <input type="text" formControlName="age" readonly />
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Información Adicional -->
        <div class="form-section" [class.active]="currentSection === 2">
            <h3><i class="fas fa-info-circle"></i> Información Adicional</h3>
            <div formGroupName="patient">
                <div class="form-row">
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" formControlName="phoneNumber" placeholder="Ej: 3201234567" />
                    </div>

                    <div class="form-group">
                        <label>Correo Electrónico</label>
                        <input type="email" formControlName="email" placeholder="correo@ejemplo.com" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nivel Económico</label>
                        <select formControlName="economicStatus">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let nivel of nivelesEconomicos" [value]="nivel.value">
                                {{ nivel.label }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nivel de Educación</label>
                        <select formControlName="educationLevel">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let nivel of nivelesEducacion" [value]="nivel.value">
                                {{ nivel.label }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Estado Civil</label>
                        <select formControlName="maritalStatus">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let estado of estadosCiviles" [value]="estado.value">
                                {{ estado.label }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Estado de Crisis</label>
                        <select formControlName="crisisStatus">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let estado of estadosCrisis" [value]="estado.value">
                                {{ estado.label }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad de Origen</label>
                        <input type="text" formControlName="hometown" placeholder="Ciudad de origen" />
                    </div>

                    <div class="form-group">
                        <label>Ciudad Actual</label>
                        <input type="text" formControlName="currentCity" placeholder="Ciudad actual" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Primera Crisis</label>
                        <input type="date" formControlName="firstCrisisDate" />
                    </div>

                    <div class="form-group">
                        <label>Fecha de Fallecimiento</label>
                        <input type="date" formControlName="deathDate" />
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Cuidador -->
        <div class="form-section" [class.active]="currentSection === 3">
            <h3>
                <i class="fas fa-hands-helping"></i> Cuidador
                <label class="switch">
                    <input type="checkbox" [checked]="hasCaregiver" (change)="toggleCaregiver()" />
                    <span class="slider round"></span>
                </label>
            </h3>

            <div *ngIf="hasCaregiver" class="caregiver-section" formGroupName="caregiver">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Cuidador</label>
                        <input type="text" formControlName="name" placeholder="Nombre completo" />
                    </div>

                    <div class="form-group">
                        <label>Tipo de Identificación</label>
                        <select formControlName="identificationType">
                            <option *ngFor="let tipo of tiposIdentificacion" [value]="tipo.value">
                                {{ tipo.label }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Número de Identificación</label>
                        <input type="text" formControlName="identificationNumber" placeholder="Ej: 987654321" />
                    </div>

                    <div class="form-group">
                        <label>Edad</label>
                        <input type="number" formControlName="age" placeholder="Edad" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nivel de Educación</label>
                        <select formControlName="educationLevel">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let nivel of nivelesEducacion" [value]="nivel.value">
                                {{ nivel.label }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ocupación</label>
                        <input type="text" formControlName="occupation" placeholder="Ocupación" />
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn btn-next" (click)="nextSection()" [disabled]="variables.length === 0">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sección: Variables -->
        <div class="form-section" [class.active]="currentSection === 4" *ngIf="variables.length > 0">
            <h3><i class="fas fa-list"></i> Variables de la Capa</h3>

            <div class="variables-container">
                <div formArrayName="variables">
                    <div *ngFor="let variable of variablesFormGroups; let i = index" [formGroup]="variable"
                        class="variable-field">
                        <div class="form-group">
                            <label>
                                {{ variable.get('variableName')?.value }}
                                <span *ngIf="variable.get('isRequired')?.value" class="required-asterisk">*</span>
                                <span class="variable-type-badge" [attr.data-type]="variable.get('type')?.value">
                                    {{ getTypeLabel(variable.get('type')?.value) }}
                                </span>
                            </label>

                            <!-- ENTERO - Número entero -->
                            <div *ngIf="variable.get('type')?.value === 'Entero'" class="input-container">
                                <input type="number" formControlName="value" step="1" placeholder="Ej: 1, 2, 3"
                                    (keypress)="validateNumber($event)" class="form-control" />
                                <i class="fas fa-hashtag input-icon"></i>
                            </div>

                            <!-- REAL - Número decimal -->
                            <div *ngIf="variable.get('type')?.value === 'Real'" class="input-container">
                                <input type="number" formControlName="value" step="0.01"
                                    placeholder="Ej: 1.5, 2.75, 3.14" (keypress)="validateDecimal($event)"
                                    class="form-control" />
                                <i class="fas fa-divide input-icon"></i>
                            </div>

                            <!-- TEXTO - Campo de texto -->
                            <div *ngIf="variable.get('type')?.value === 'Texto'" class="input-container">
                                <textarea formControlName="value" rows="3" placeholder="Ej: Juan, Azul"
                                    class="form-control"></textarea>
                                <i class="fas fa-font input-icon"></i>
                            </div>

                            <!-- FECHA - Selector de fecha -->
                            <div *ngIf="variable.get('type')?.value === 'Fecha'" class="input-container">
                                <input type="date" formControlName="value" class="form-control" />
                                <i class="fas fa-calendar-alt input-icon"></i>
                            </div>

                            <!-- LÓGICO - Checkbox booleano -->
                            <div *ngIf="variable.get('type')?.value === 'Lógico'" class="checkbox-container">
                                <label class="checkbox-label large">
                                    <input type="checkbox" formControlName="value"
                                        (change)="onCheckboxChange(variable, $event)" class="checkbox-input" />
                                    <span class="checkmark"></span>
                                    <span class="checkbox-text">
                                        {{ variable.get('value')?.value ? 'Sí' : 'No' }}
                                    </span>
                                </label>
                                <i class="fas fa-check-double input-icon"></i>
                            </div>

                            <!-- Mensajes de error -->
                            <div *ngIf="variable.get('value')?.invalid && variable.get('value')?.touched"
                                class="error-message">
                                {{ getErrorMessage(variable) }}
                            </div>

                            <!-- Texto de ayuda -->
                            <div *ngIf="variable.get('value')?.valid && variable.get('value')?.value" class="help-text">
                                {{ getTypeDescription(variable.get('type')?.value) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-navigation-controls">
                <button type="button" class="btn btn-prev" (click)="prevSection()">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button type="submit" class="btn btn-submit" [disabled]="loading">
                    <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status"
                        aria-hidden="true"></span>
                    <i *ngIf="!loading" class="fas fa-save"></i>
                    {{ loading ? 'Guardando...' : 'Guardar Registro' }}
                </button>
            </div>
        </div>

    </form>

    <!-- Botones de acción globales -->
    <div class="form-actions" *ngIf="!loadingVariables && currentSection !== 4">
        <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="loading">
            <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="submit" class="btn btn-submit" [disabled]="loading || registroForm.invalid" (click)="onSubmit()">
            <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <i *ngIf="!loading" class="fas fa-save"></i>
            {{ loading ? 'Guardando...' : 'Guardar Registro' }}
        </button>
    </div>
</div>