<!-- Componente Admin Principal -->
<div class="admin">
  <!-- Navbar del administrador -->
  <app-navbar-admin (tabSelected)="onTabSelected($event)"></app-navbar-admin>

  <!-- Contenedor principal del contenido -->
  <div class="contentAdmin">
    <!-- Sección de Inicio con Dashboard -->
    <div *ngIf="selectedTab === 'inicioAdmin'" class="dashboard">
      <!-- Tarjetas de Métricas -->
      <div class="dashboard-metrics">
        <div class="metric-card">
          <div class="metric-content">
            <i class="fas fa-users"></i> <!-- Icono de usuarios -->
            <div class="metric-text">
              <h3>Usuarios Registrados</h3>
              <p>{{ totalUsuarios }}</p>
            </div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-content">
            <i class="fas fa-layer-group"></i> <!-- Icono de capas -->
            <div class="metric-text">
              <h3>Capas Creadas</h3>
              <p>{{ totalCapas }}</p>
            </div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-content">
            <i class="fas fa-cogs"></i> <!-- Icono de configuración -->
            <div class="metric-text">
              <h3>Variables Definidas</h3>
              <p>{{ totalVariables }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Registro de Actividad Reciente -->
      <div class="dashboard">
        <div class="dashboard-container">
          <!-- Columna izquierda: Accesos Rápidos y Últimos usuarios creados -->
          <div class="left-column">
            <div class="accesos-rapidos">
              <h2>Accesos Rápidos</h2>
              <div class="dashboard-actions">
                <button mat-button color="primary" (click)="crearNuevoUsuario()">
                  <mat-icon>person_add</mat-icon> Crear Usuario
                </button>
                <button mat-button color="accent" (click)="crearNuevaCapa()">
                  <mat-icon>layers</mat-icon> Agregar Capa
                </button>
                <button mat-button color="warn" (click)="crearNuevaVariable()">
                  <mat-icon>settings</mat-icon> Agregar Variable
                </button>
              </div>
              <ul>
                <h2> Últimos usuarios creados</h2>
                <li *ngFor="let usuario of ultimosUsuarios" (click)="handleView(usuario, 'usuario')">
                  👤 {{ usuario.nombre }} - {{ usuario.rol }}
                </li>
              </ul>
              <div class="descarga">
                <button mat-raised-button color="primary" (click)="exportarCSV()">
                  <mat-icon>download</mat-icon> Exportar datos de todos los usuarios
                </button>
              </div>

            </div>
          </div>

          <!-- Columna derecha: Últimos Registros -->
          <div class="right-column">
            <h2>Últimos registros de {{username}}</h2>
            <table *ngIf="dataSource && dataSource.data.length > 0" mat-table [dataSource]="dataSource" class="table">
              <!-- Tipo -->
              <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef> Tipo </th>
                <td mat-cell *matCellDef="let registro"> {{ registro.tipo }} </td>
              </ng-container>

              <!-- Detalles Específicos -->
              <ng-container matColumnDef="detalles">
                <th mat-header-cell *matHeaderCellDef> Detalles </th>
                <td mat-cell *matCellDef="let registro">
                  <ng-container *ngIf="registro.tipo === 'usuario'">
                    <b>Usuario:</b> {{ registro.data.username }} <br>
                    <b>Email:</b> {{ registro.data.email }} <br>
                    <b>Rol:</b> {{ registro.data.attributes?.role?.join(', ') || 'Sin rol' }}
                  </ng-container>

                  <ng-container *ngIf="registro.tipo === 'capa'">
                    <b>Nombre Capa:</b> {{ registro.data.layerName || registro.data.nombreCapa }} <br>
                    <b>Jefe:</b> {{ registro.data.layerBoss?.name || registro.data.jefeCapa?.nombre }} <br>
                    <b>Identificación Jefe:</b> {{ registro.data.layerBoss?.identificationNumber ||
                    registro.data.jefeCapa?.numeroIdentificacion || 'N/A' }}
                  </ng-container>

                  <ng-container *ngIf="registro.tipo === 'variable'">
                    <b>Nombre Variable:</b> {{ registro.data.variableName || 'Sin nombre' }} <br>
                    <b>Descripción:</b> {{ registro.data.description || 'Sin descripción' }} <br>
                    <b>Tipo:</b> {{ registro.data.type || 'Sin tipo' }} <br>
                    <b>Opciones:</b> {{ registro.data.options?.join(', ') || 'Ninguna' }}
                  </ng-container>                                  
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['tipo', 'detalles']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['tipo', 'detalles'];"></tr>
            </table>

            <!-- Paginación -->
            <mat-paginator [pageSize]="5" [pageSizeOptions]="[3, 5, 10]" showFirstLastButtons></mat-paginator>
          </div>
        </div>
      </div>
    </div>

    <!-- Gestión de Usuarios -->
    <div *ngIf="selectedTab === 'gestionUsuarios'">
      <div *ngIf="!isCreatingUser && !isEditingUser">
        <div class="action-bar">
          <button class="btn btn-primary create-button" (click)="crearNuevoUsuario()">
            Crear nuevo usuario
          </button>
        </div>
        <app-table [data]="usuariosData" [columns]="usuariosColumns" [itemsPerPageOptions]="[5, 10, 20]"
          (onView)="handleViewUser($event, 'usuario')" (onEdit)="handleEdit($event, 'usuario')"
          (onDelete)="handleDelete($event)">
        </app-table>
      </div>

      <!-- Formulario de Creación de Usuario -->
      <div *ngIf="isCreatingUser" class="contentAdmin2">
        <app-form-registro-usuario (closeForm)="isCreatingUser = false"></app-form-registro-usuario>
      </div>
    </div>

    <!-- Gestión de Variables -->
    <div *ngIf="selectedTab === 'gestionVariables'">
      <div *ngIf="!isCreatingVar && !isEditingVar">
        <div class="action-bar">
          <button class="btn btn-primary create-button" (click)="crearNuevaVariable()">
            Crear nueva variable
          </button>
        </div>
        <app-table [data]="variablesData" [columns]="variablesColumns" [itemsPerPageOptions]="[5, 10, 20]"
          (onView)="handleView($event, 'variable')" (onEdit)="handleEdit($event, 'variable')"
          (onDelete)="handleDelete($event)">
        </app-table>
      </div>
      <div *ngIf="isCreatingVar" class="contentAdmin2">
        <app-form-registro-variables (closeForm)="isCreatingVar = false"></app-form-registro-variables>
      </div>
    </div>

    <!-- Gestión de Capas -->
    <div *ngIf="selectedTab === 'gestionCapas'">
      <div *ngIf="!isCreatingCapa && !isEditingCapa">
        <div class="action-bar">
          <button class="btn btn-primary create-button" (click)="crearNuevaCapa()">
            Crear nueva capa
          </button>
        </div>
        <app-table [data]="capasData" [columns]="capasColumns" [itemsPerPageOptions]="[5, 10, 20]"
          (onView)="handleView($event, 'capa')" (onEdit)="handleEdit($event, 'capa')" (onDelete)="handleDelete($event)">
        </app-table>
      </div>
      <div *ngIf="isCreatingCapa" class="contentAdmin2">
        <app-form-registro-capas (closeForm)="isCreatingCapa = false"></app-form-registro-capas>
      </div>

    </div>
  </div>
</div>

<!-- Modal para ver detalles -->
<div *ngIf="isViewing" class="modal-overlay">
  <div class="modal-content">
    <h2>Detalles de {{ viewType }}</h2>

    <div *ngIf="viewType === 'usuario'" class="modal-content">
      <div class="modal-body">
        <p><strong>Nombre:</strong> {{ viewedItem.nombre }}</p>
        <p><strong>Apellido:</strong> {{ viewedItem.apellido }}</p>
        <p><strong>Documento:</strong> {{ viewedItem.documento }}</p>
        <p><strong>Capa:</strong> {{ viewedItem.capa }}</p>
        <p><strong>Rol:</strong> {{ viewedItem.rol }}</p>
      </div>
    </div>

    <div *ngIf="viewType === 'variable'" class="modal-content">
      <div class="modal-body">
        <p><strong>Nombre:</strong> {{ viewedItem.variableName || viewedItem.nombre }}</p>
        <p><strong>Descripción:</strong> {{ viewedItem.description || viewedItem.descripcion }}</p>
        <p><strong>Capa:</strong> {{ getCapaNombreByIdVariables(viewedItem.researchLayerId || viewedItem.idCapaInvestigacion) }}
        </p>
        <p><strong>Tipo:</strong> {{ viewedItem.type || viewedItem.tipo }}</p>

        <div *ngIf="(viewedItem.options || viewedItem.opciones)?.length > 0">
          <p><strong>Opciones:</strong></p>
          <ul>
            <li *ngFor="let opcion of (viewedItem.options || viewedItem.opciones)">{{ opcion }}</li>
          </ul>
        </div>
      </div>
    </div>


    <div *ngIf="viewType === 'capa'" class="modal-content">
      <div class="modal-body">
        <p><strong>Nombre:</strong> {{ viewedItem.layerName || viewedItem.nombreCapa }}</p>
        <p><strong>Descripción:</strong> {{ viewedItem.description || viewedItem.descripcion }}</p>
        <p><strong>Jefe:</strong> {{ viewedItem.layerBoss?.name || viewedItem.jefeCapaNombre }}</p>
        <p><strong>Identificación Jefe:</strong> {{ viewedItem.layerBoss?.identificationNumber ||
          viewedItem.jefeIdentificacion }}</p>
      </div>
    </div>
    <div class="form-buttons">
      <button (click)="cerrarModal()" class="btn btn-secondary">Cerrar</button>
    </div>

  </div>
</div>

<!-- Modal para editar Capa -->
<div *ngIf="isEditingCapa" class="modal-overlay">
  <div class="user-form-container">
    <h2>Editar Capa</h2>
    <form (submit)="guardarEdicionCapa()">
      <div class="form-row">
        <label>Nombre:</label>
        <input type="text" [(ngModel)]="capaToEdit.nombreCapa" name="nombreCapa" required />
      </div>
      <div class="form-row">
        <label>Descripción:</label>
        <input type="text" [(ngModel)]="capaToEdit.descripcion" name="descripcion" required />
      </div>
      <div class="form-row">
        <label>Nombre del Jefe de Capa:</label>
        <input type="text" [(ngModel)]="capaToEdit.jefeCapaNombre" name="jefeCapaNombre" required />
      </div>
      <div class="form-row">
        <label>Número de Identificación del Jefe de Capa:</label>
        <input type="text" [(ngModel)]="capaToEdit.jefeIdentificacion" name="jefeIdentificacion" required />
      </div>
      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button type="button" class="btn btn-secondary" (click)="isEditingCapa = false">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para editar Variable -->
<div *ngIf="isEditingVar" class="modal-overlay">
  <div class="user-form-container">
    <h2>Editar Variable</h2>
    <form (ngSubmit)="guardarEdicionVariable(varToEdit)">
      <div class="form-row">
        <label>Nombre:</label>
        <input type="text" [(ngModel)]="varToEdit.variableName" name="variableName" required />
      </div>
      <div class="form-row">
        <label>Descripción:</label>
        <input type="text" [(ngModel)]="varToEdit.description" name="description" required />
      </div>
      <div class="form-row">
        <label>Capa de Investigación:</label>
        <select [(ngModel)]="varToEdit.researchLayerId" name="researchLayerId" required>
          <option *ngFor="let capa of capasData" [value]="capa.id" [selected]="capa.id === varToEdit.researchLayerId">
            {{ capa.layerName || capa.nombreCapa }}
          </option>
        </select>
      </div>

      <div class="form-row">
        <label>Tipo de Variable:</label>
        <select [(ngModel)]="varToEdit.type" name="type" required>
          <option *ngFor="let tipo of tiposVariables" [value]="tipo" [selected]="tipo === varToEdit.type">
            {{ tipo }}
          </option>
        </select>
      </div>

      <div class="form-row checkbox-row">
        <label>
          <span>¿Tiene opciones?</span>
          <input type="checkbox" [(ngModel)]="varToEdit.tieneOpciones" name="tieneOpciones"
            (change)="onTieneOpcionesChange()" />
        </label>
      </div>

      <div class="form-row" *ngIf="varToEdit.tieneOpciones">
        <label class="options">Opciones:</label>
        <div *ngFor="let opcion of varToEdit.options; let i = index; trackBy: trackByIndex" class="option-item">
          <input type="text" [(ngModel)]="varToEdit.options[i]" [name]="'option' + i" required />
          <button type="button" (click)="eliminarOpcion(i)" class="btn btn-danger">✖</button>
        </div>
        <button type="button" class="btn btn-success" (click)="agregarOpcion()">➕ Agregar Opción</button>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">Guardar datos</button>
        <button type="button" class="btn btn-secondary" (click)="isEditingVar = false">Cancelar edición</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para editar Variable -->
<div *ngIf="isEditingUserModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Editar Usuario</h2>
    <form (submit)="guardarEdicionUsuario(userToEdit)">
      <div class="form-grid">
        <div class="form-row">
          <label>Nombre:</label>
          <input type="text" [(ngModel)]="userToEdit.nombre" name="nombre" required />
        </div>

        <div class="form-row">
          <label>Apellido:</label>
          <input type="text" [(ngModel)]="userToEdit.apellido" name="apellido" required />
        </div>

        <div class="form-row">
          <label>Email:</label>
          <input type="email" [(ngModel)]="userToEdit.email" name="email" required />
        </div>

        <div class="form-row">
          <label>Contraseña (Solo si desea actualizar):</label>
          <input type="password" [(ngModel)]="userToEdit.password" name="password" placeholder="Nueva contraseña" />
        </div>

        <div class="form-row">
          <label>Usuario:</label>
          <input type="text" [(ngModel)]="userToEdit.usuario" name="usuario" required disabled />
        </div>

        <div class="form-row">
          <label>Tipo de Identificación:</label>
          <input type="text" [(ngModel)]="userToEdit.tipoDocumento" name="tipoDocumento" required disabled />
        </div>

        <div class="form-row">
          <label>Número de Identificación:</label>
          <input type="number" [(ngModel)]="userToEdit.documento" name="documento" required disabled />
        </div>

        <div class="form-row">
          <label>Fecha de Nacimiento:</label>
          <input type="date" [(ngModel)]="userToEdit.fechaNacimiento" name="fechaNacimiento" required disabled />
        </div>

        <div class="form-row">
          <label>Capa de Investigación:</label>
          <select [(ngModel)]="userToEdit.researchLayerId" name="researchLayerId" required>
            <option value="" disabled>Selecciona una capa</option>
            <option *ngFor="let capa of capas" 
                    [value]="capa.layerName || capa.nombreCapa"
                    [selected]="(capa.layerName || capa.nombreCapa) === userToEdit.capaRawValue">
              {{ capa.layerName || capa.nombreCapa }}
            </option>
          </select>
        </div>

        <div class="form-row">
          <label>Rol:</label>
          <select [(ngModel)]="userToEdit.rol" name="rol" required>
            <option value="" disabled selected>Selecciona un rol</option>
            <option value="Admin">Administrador</option>
            <option value="Researcher">Investigador</option>
            <option value="Doctor">Personal de salud</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button type="button" class="btn btn-secondary" (click)="isEditingUserModal = false">Cancelar</button>
      </div>
    </form>
  </div>
</div>