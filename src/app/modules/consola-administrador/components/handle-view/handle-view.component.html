<div class="modal-overlay">
    <div class="modal-content" [class.historial-modal]="viewType === 'historial'">

        <!-- Header unificado -->
        <div class="modal-header" [class.patient-header]="viewType === 'historial'">
            <div class="header-content">
                <div *ngIf="viewType === 'historial'" class="patient-header-info">
                    <div class="patient-avatar">
                        <mat-icon>person</mat-icon>
                    </div>
                    <div class="patient-title">
                        <h2>
                            Información del Paciente
                            <span class="historial-badge">(Historial)</span>
                        </h2>
                        <p *ngIf="viewedItem">
                            {{getPatientInfo()?.name || 'No especificado'}} •
                            {{viewedItem.patientIdentificationNumber || 'No especificado'}}
                        </p>
                    </div>
                </div>

                <div *ngIf="viewType !== 'historial'" class="standard-header-info">
                    <h5 class="modal-title">
                        <ng-container [ngSwitch]="viewType">
                            <i *ngSwitchCase="'usuario'" class="fas fa-user-circle"></i>
                            <i *ngSwitchCase="'variable'" class="fas fa-list-alt"></i>
                            <i *ngSwitchCase="'capa'" class="fas fa-layer-group"></i>
                            <i *ngSwitchDefault class="fas fa-eye"></i>
                        </ng-container>
                        Detalles de {{viewType}}
                    </h5>
                </div>
            </div>

            <button type="button" class="btn-close" (click)="cerrarModal()" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <!-- Información específica del historial -->
            <div *ngIf="viewType === 'historial'" class="historial-metadata">
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <strong>Operación:</strong>
                        <span class="operation-badge">{{getOperationDisplay()}}</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Modificado por:</strong>
                        <span>{{viewedItem.changedBy}}</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Fecha:</strong>
                        <span>{{formatDate(viewedItem.changedAt)}}</span>
                    </div>
                </div>
            </div>

            <!-- Loading state -->
            <div *ngIf="viewType === 'historial' && loadingRegistroCompleto" class="loading-section">
                <div class="loading-content">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Cargando información completa del registro...</p>
                </div>
            </div>

            <ng-container [ngSwitch]="viewType">

                <!-- VISTA PARA USUARIOS -->
                <div *ngSwitchCase="'usuario'" class="detail-view user-view">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="detail-content">
                                <label>Nombre completo</label>
                                <span>{{viewedItem.nombre}} {{viewedItem.apellido}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-at"></i>
                            </div>
                            <div class="detail-content">
                                <label>Usuario</label>
                                <span>{{viewedItem.usuario || viewedItem.username}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="detail-content">
                                <label>Email</label>
                                <span>{{viewedItem.email}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <div class="detail-content">
                                <label>Documento</label>
                                <span>{{getTipoIdentificacion(viewedItem.tipoDocumento)}}
                                    {{viewedItem.documento}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-birthday-cake"></i>
                            </div>
                            <div class="detail-content">
                                <label>Fecha de Nacimiento</label>
                                <span>{{viewedItem.fechaNacimiento || 'No especificada'}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="detail-content">
                                <label>Capas de Investigación</label>
                                <div class="capas-list">
                                    <span *ngIf="getCapaIds().length > 0; else noCapas">
                                        <span *ngFor="let id of getCapaIds()" class="capa-badge">
                                            {{ getNombreCapa(id) }}
                                        </span>
                                    </span>
                                    <ng-template #noCapas>
                                        <span class="no-data">Sin capas asignadas</span>
                                    </ng-template>
                                </div>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-user-tag"></i>
                            </div>
                            <div class="detail-content">
                                <label>Rol</label>
                                <span class="role-badge">{{getRolFormateado(viewedItem.rol || viewedItem.role)}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-power-off"></i>
                            </div>
                            <div class="detail-content">
                                <label>Estado</label>
                                <span [class]="viewedItem.enabled ? 'status-active' : 'status-inactive'">
                                    {{viewedItem.enabled ? 'Activo' : 'Inactivo'}}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA PARA VARIABLES -->
                <div *ngSwitchCase="'variable'" class="detail-view variable-view">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <div class="detail-content">
                                <label>Nombre</label>
                                <span>{{viewedItem.variableName}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-align-left"></i>
                            </div>
                            <div class="detail-content">
                                <label>Descripción</label>
                                <span>{{viewedItem.description || 'Sin descripción'}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="detail-content">
                                <label>Tipo de dato</label>
                                <span class="type-badge">{{viewedItem.type}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="detail-content">
                                <label>Capa asociada</label>
                                <span>{{viewedItem.capaNombre}}</span>
                            </div>
                        </div>

                        <div *ngIf="viewedItem.options && viewedItem.options.length > 0" class="detail-item full-width">
                            <div class="detail-icon">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="detail-content">
                                <label>Opciones disponibles</label>
                                <div class="options-grid">
                                    <span *ngFor="let option of viewedItem.options" class="option-chip">
                                        {{option}}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA PARA CAPAS -->
                <div *ngSwitchCase="'capa'" class="detail-view capa-view">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <div class="detail-content">
                                <label>Nombre de la capa</label>
                                <span>{{viewedItem.nombreCapa || viewedItem.layerName}}</span>
                            </div>
                        </div>

                        <div class="detail-item full-width">
                            <div class="detail-icon">
                                <i class="fas fa-align-left"></i>
                            </div>
                            <div class="detail-content">
                                <label>Descripción</label>
                                <span>{{viewedItem.descripcion || viewedItem.description || 'Sin descripción'}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="detail-content">
                                <label>Jefe de Capa</label>
                                <span>{{viewedItem.jefeCapaNombre || (viewedItem.layerBoss?.name || 'Sin
                                    asignar')}}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <div class="detail-content">
                                <label>Documento del Jefe</label>
                                <span>{{viewedItem.jefeIdentificacion || (viewedItem.layerBoss?.identificationNumber ||
                                    'Sin asignar')}}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de variables asociadas -->
                    <div *ngIf="variablesAsociadas.length > 0" class="variables-section">
                        <div class="section-header">
                            <h3>
                                <i class="fas fa-list-alt"></i>
                                Variables Asociadas
                                <span class="count-badge">{{filteredVariables.length}}</span>
                            </h3>

                            <div class="search-container">
                                <div class="search-wrapper">
                                    <i class="fas fa-search"></i>
                                    <input type="text" [(ngModel)]="searchTerm" (input)="filterVariables()"
                                        placeholder="Buscar variables..." class="search-input">
                                    <button *ngIf="searchTerm" (click)="searchTerm = ''; filterVariables()"
                                        class="clear-search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="variables-grid">
                            <div *ngFor="let variable of paginatedVariables" class="variable-card">
                                <div class="variable-header">
                                    <span class="variable-name">{{ variable.variableName }}</span>
                                    <span class="variable-type">{{ variable.type }}</span>
                                </div>
                                <div *ngIf="variable.description" class="variable-description">
                                    {{ variable.description }}
                                </div>
                                <div *ngIf="variable.options && variable.options.length > 0" class="variable-options">
                                    <span class="options-label">Opciones:</span>
                                    <div class="options-container">
                                        <span *ngFor="let option of variable.options" class="option-tag">
                                            {{ option }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paginación -->
                        <div class="pagination-controls" *ngIf="filteredVariables.length > pageSize">
                            <div class="pagination-info">
                                Mostrando {{(currentPage - 1) * pageSize + 1}} -
                                {{min(currentPage * pageSize, filteredVariables.length)}}
                                de {{filteredVariables.length}} variables
                            </div>
                            <div class="pagination-buttons">
                                <button (click)="previousPage()" [disabled]="currentPage === 1"
                                    class="pagination-btn prev-btn">
                                    <i class="fas fa-chevron-left"></i> Anterior
                                </button>

                                <span class="page-indicator">
                                    Página {{currentPage}} de {{totalPages}}
                                </span>

                                <button (click)="nextPage()" [disabled]="currentPage === totalPages"
                                    class="pagination-btn next-btn">
                                    Siguiente <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-selector">
                                <option value="5">5 por página</option>
                                <option value="10">10 por página</option>
                                <option value="20">20 por página</option>
                                <option value="50">50 por página</option>
                            </select>
                        </div>
                    </div>

                    <div *ngIf="variablesAsociadas.length === 0" class="empty-variables">
                        <i class="fas fa-inbox"></i>
                        <p>No hay variables asociadas a esta capa</p>
                    </div>
                </div>

                <!-- VISTA PARA HISTORIAL -->
                <div *ngSwitchCase="'historial'" class="detail-view historial-view">
                    <div *ngIf="!loadingRegistroCompleto" class="historial-content">

                        <!-- Navegación por pestañas -->
                        <nav class="detail-tabs">
                            <button class="tab-button" [class.active]="activeTab === 'basic'"
                                (click)="activeTab = 'basic'">
                                <i class="fas fa-user"></i>
                                Información Básica
                            </button>
                            <button class="tab-button" [class.active]="activeTab === 'caregiver'"
                                (click)="activeTab = 'caregiver'" *ngIf="hasCaregiverData()">
                                <i class="fas fa-user-friends"></i>
                                Cuidador
                            </button>
                            <button class="tab-button" [class.active]="activeTab === 'research'"
                                (click)="activeTab = 'research'" *ngIf="getVariables().length > 0">
                                <i class="fas fa-flask"></i>
                                Investigación
                            </button>
                            <button class="tab-button" [class.active]="activeTab === 'layer'"
                                (click)="activeTab = 'layer'" *ngIf="getLayerInfo().researchLayerName">
                                <i class="fas fa-layer-group"></i>
                                Capa
                            </button>
                        </nav>

                        <!-- Contenido de pestañas -->
                        <div class="tab-content-wrapper">

                            <!-- Pestaña Información Básica -->
                            <div class="tab-pane" [class.active]="activeTab === 'basic'">
                                <div class="info-section">
                                    <h4><i class="fas fa-id-card"></i> Datos de Identificación</h4>
                                    <div class="info-grid">
                                        <div class="info-field">
                                            <label>Número de documento:</label>
                                            <span>
                                                {{viewedItem.patientIdentificationNumber || 'No disponible'}}
                                                ({{getTipoIdentificacion(getPatientIdentificationType())}})
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-section" *ngIf="getPatientInfo()">
                                    <h4><i class="fas fa-user"></i> Datos Personales</h4>
                                    <div class="info-grid">
                                        <div class="info-field" *ngIf="getPatientInfo().name">
                                            <label>Nombre completo:</label>
                                            <span>{{getPatientInfo().name}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().sex">
                                            <label>Sexo:</label>
                                            <span>{{getLabel(generos, getPatientInfo().sex) ||
                                                getPatientInfo().sex}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().age">
                                            <label>Edad:</label>
                                            <span>{{getPatientInfo().age}} años</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().birthDate">
                                            <label>Fecha de nacimiento:</label>
                                            <span>{{formatDate(getPatientInfo().birthDate)}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().email">
                                            <label>Email:</label>
                                            <span>{{getPatientInfo().email}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().phoneNumber">
                                            <label>Teléfono:</label>
                                            <span>{{getPatientInfo().phoneNumber}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().maritalStatus">
                                            <label>Estado civil:</label>
                                            <span>{{getLabel(estadosCiviles, getPatientInfo().maritalStatus) ||
                                                getPatientInfo().maritalStatus}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().educationLevel">
                                            <label>Nivel educativo:</label>
                                            <span>{{getLabel(nivelesEducacion, getPatientInfo().educationLevel) ||
                                                getPatientInfo().educationLevel}}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-section"
                                    *ngIf="getPatientInfo()?.hometown || getPatientInfo()?.currentCity">
                                    <h4><i class="fas fa-map-marker-alt"></i> Información Geográfica</h4>
                                    <div class="info-grid">
                                        <div class="info-field" *ngIf="getPatientInfo().hometown">
                                            <label>Ciudad de origen:</label>
                                            <span>{{getPatientInfo().hometown}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().currentCity">
                                            <label>Ciudad actual:</label>
                                            <span>{{getPatientInfo().currentCity}}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-section"
                                    *ngIf="getPatientInfo()?.economicStatus || getPatientInfo()?.firstCrisisDate || getPatientInfo()?.crisisStatus">
                                    <h4><i class="fas fa-chart-line"></i> Estado y Situación</h4>
                                    <div class="info-grid">
                                        <div class="info-field" *ngIf="getPatientInfo().economicStatus">
                                            <label>Nivel económico:</label>
                                            <span>{{getLabel(estadosEconomicos, getPatientInfo().economicStatus) ||
                                                getPatientInfo().economicStatus}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().firstCrisisDate">
                                            <label>Primera crisis:</label>
                                            <span>{{formatDate(getPatientInfo().firstCrisisDate)}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().crisisStatus">
                                            <label>Estado de crisis:</label>
                                            <span class="crisis-status">{{getPatientInfo().crisisStatus}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getPatientInfo().deathDate">
                                            <label>Fecha de fallecimiento:</label>
                                            <span>{{formatDate(getPatientInfo().deathDate)}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña Cuidador -->
                            <div class="tab-pane" [class.active]="activeTab === 'caregiver'" *ngIf="hasCaregiverData()">
                                <div class="info-section">
                                    <h4><i class="fas fa-user-friends"></i> Información del Cuidador</h4>
                                    <div class="info-grid">
                                        <div class="info-field" *ngIf="getCaregiver()?.name">
                                            <label>Nombre:</label>
                                            <span>{{getCaregiver().name}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getCaregiver()?.identificationNumber">
                                            <label>Documento:</label>
                                            <span>{{getCaregiver().identificationNumber}}
                                                ({{getLabel(tiposIdentificacion, getCaregiver()?.identificationType) ||
                                                'No especificado'}})
                                            </span>
                                        </div>
                                        <div class="info-field" *ngIf="getCaregiver()?.age">
                                            <label>Edad:</label>
                                            <span>{{getCaregiver().age}} años</span>
                                        </div>
                                        <div class="info-field" *ngIf="getCaregiver()?.educationLevel">
                                            <label>Nivel educativo:</label>
                                            <span>{{getCaregiver().educationLevel}}</span>
                                        </div>
                                        <div class="info-field" *ngIf="getCaregiver()?.occupation">
                                            <label>Ocupación:</label>
                                            <span>{{getCaregiver().occupation}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña Investigación -->
                            <div class="tab-pane" [class.active]="activeTab === 'research'"
                                *ngIf="getVariables().length > 0">
                                <div class="info-section">
                                    <h4><i class="fas fa-flask"></i> Variables de Investigación</h4>
                                    <div class="variables-research-grid">
                                        <div *ngFor="let variable of getVariables()" class="research-variable">
                                            <div class="variable-header">
                                                <span class="variable-name">{{getVariableName(variable)}}</span>
                                                <span class="variable-type">{{getVariableType(variable)}}</span>
                                            </div>
                                            <div class="variable-value">
                                                {{formatVariableValue(variable)}}
                                            </div>
                                            <div *ngIf="variable.description" class="variable-description">
                                                {{variable.description}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña Capa -->
                            <div class="tab-pane" [class.active]="activeTab === 'layer'"
                                *ngIf="getLayerInfo().researchLayerName">
                                <div class="info-section">
                                    <h4><i class="fas fa-layer-group"></i> Información de la Capa</h4>
                                    <div class="info-grid">
                                        <div class="info-field">
                                            <label>Nombre de la capa:</label>
                                            <span>{{getLayerInfo().researchLayerName}}</span>
                                        </div>
                                        <div class="info-field">
                                            <label>ID de la capa:</label>
                                            <span class="layer-id">{{getLayerInfo().researchLayerId}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje si no hay información -->
                        <div *ngIf="isPatientInfoEmpty()" class="empty-state">
                            <div class="empty-content">
                                <i class="fas fa-info-circle"></i>
                                <p>No se encontró información detallada del paciente en el historial.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </ng-container>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
                <i class="fas fa-times"></i> Cerrar
            </button>

            <!-- <div class="footer-actions" *ngIf="viewType === 'historial'">
                <button type="button" class="btn btn-outline-primary" (click)="exportHistorialData()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="printHistorial()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div> -->
        </div>
    </div>
</div>