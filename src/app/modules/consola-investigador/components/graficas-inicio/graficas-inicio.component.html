<div class="research-dashboard">
  <header class="dashboard-header">
    <div class="header-container">
      <div class="header-brand">
        <mat-icon class="brand-icon">science</mat-icon>
        <h1 class="dashboard-title">Dashboard de Investigación</h1>
      </div>
      <div class="header-actions">
        <button mat-icon-button (click)="toggleTheme()" matTooltip="Cambiar tema">
          <mat-icon>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="exportAllCharts()">
          <mat-icon>download</mat-icon>
          Exportar Todo
        </button>
      </div>
    </div>

    <div class="current-layer" *ngIf="currentResearchLayer?.layerName">
      <div class="layer-badge">
        <mat-icon>layers</mat-icon>
        <span class="layer-name">{{ currentResearchLayer?.layerName }}</span>
      </div>
      <div class="layer-boss" *ngIf="currentResearchLayer?.layerBoss?.name">
        <mat-icon>person</mat-icon>
        <span>Responsable: {{ currentResearchLayer?.layerBoss?.name }}</span>
      </div>
      <div class="layer-stats">
        <span class="stat">
          <mat-icon>update</mat-icon>
          Última actualización: {{ getUltimaActualizacion() }}
        </span>
        <span class="stat">
          <mat-icon>people</mat-icon>
          Registros únicos: {{ getNumeroRegistrosUnicos() }}
        </span>
      </div>
    </div>
  </header>

  <!-- Selector de capa -->
  <section class="layer-selector-section" *ngIf="availableLayers.length > 0 && !researchLayerId">
    <div class="layer-selector-container">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>Capa de investigación</mat-label>
        <mat-select [(value)]="selectedLayerId" (selectionChange)="selectLayer($event.value)">
          <mat-option *ngFor="let layer of availableLayers" [value]="layer.id">
            <div class="layer-option">
              <span class="layer-name">{{ layer.layerName }}</span>
              <span class="layer-boss" *ngIf="layer.layerBoss?.name">
                (Responsable: {{ layer.layerBoss.name }})
              </span>
            </div>
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button matTooltip="Recargar datos" (click)="loadResearchLayerDetails(selectedLayerId!)"
        [disabled]="!selectedLayerId">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </section>

  <!-- Estado de carga -->
  <ng-container *ngIf="loading">
    <div class="loading-state">
      <div class="skeleton-header"></div>
      <div class="skeleton-cards">
        <div class="skeleton-card" *ngFor="let card of [1,2,3,4,5,6]"></div>
      </div>
      <div class="skeleton-charts">
        <div class="skeleton-chart" *ngFor="let chart of [1,2,3,4,5,6]"></div>
      </div>
    </div>
  </ng-container>

  <!-- Mensaje de error -->
  <div *ngIf="errorMessage" class="error-state">
    <div class="error-card">
      <div class="error-icon">
        <mat-icon>error_outline</mat-icon>
      </div>
      <div class="error-content">
        <h3>Error en la carga de datos</h3>
        <p>{{ errorMessage }}</p>
      </div>
      <button mat-flat-button color="primary" (click)="loadAvailableLayers()" class="retry-button">
        <mat-icon>refresh</mat-icon>
        Reintentar
      </button>
    </div>
  </div>

  <!-- Contenido principal -->
  <main *ngIf="!loading && !errorMessage" class="dashboard-content">
    <!-- Tarjetas métricas -->
    <section class="metrics-section">
      <div class="section-header">
        <h2>
          <mat-icon>dashboard</mat-icon>
          Métricas Principales
        </h2>
      </div>
      <div class="metrics-grid">
        <div *ngFor="let card of summaryCards" class="metric-card" [class.trend-up]="card.trend === 'up'"
          [class.trend-down]="card.trend === 'down'">
          <div class="metric-icon">
            <mat-icon [style.background]="getCardColor(card.trend)">{{card.icon}}</mat-icon>
          </div>
          <div class="metric-data">
            <span class="metric-title">{{card.title}}</span>
            <span class="metric-value">{{card.value | number}}</span>
            <span class="metric-description">{{card.description}}</span>
          </div>
          <div class="metric-trend" [class.positive]="card.trend === 'up'" [class.negative]="card.trend === 'down'">
            <mat-icon>{{card.trend === 'up' ? 'trending_up' : card.trend === 'down' ? 'trending_down' :
              'remove'}}</mat-icon>
            <span>{{card.change}}%</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="filters-section">
      <div class="filters-container">
        <div class="time-filter">
          <mat-icon>date_range</mat-icon>
          <button mat-button [matMenuTriggerFor]="timeMenu">
            {{ getSelectedTimeRangeLabel() }}
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
          <mat-menu #timeMenu="matMenu">
            <button mat-menu-item *ngFor="let range of timeRanges" (click)="onTimeRangeChange(range.value)">
              {{ range.label }}
            </button>
          </mat-menu>
        </div>
      </div>
    </section>

    <!-- Gráficos demográficos -->
    <section class="visualization-section">
      <div class="section-header">
        <h2>
          <mat-icon>people</mat-icon>
          Análisis Demográfico
        </h2>
      </div>

      <div class="charts-grid">
        <!-- Gráfica 1: Distribución por sexo -->
        <div class="chart-container">
          <div class="chart-header">
            <h3>
              <mat-icon>group</mat-icon>
              Distribución por Sexo
            </h3>
            <button mat-icon-button [matMenuTriggerFor]="chartMenu1">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #chartMenu1="matMenu">
              <button mat-menu-item (click)="downloadChart(1)">
                <mat-icon>download</mat-icon>
                Descargar imagen
              </button>
              <button mat-menu-item (click)="toggleChartType(1)">
                <mat-icon>swap_horiz</mat-icon>
                Cambiar tipo ({{ chartType1 }})
              </button>
            </mat-menu>
          </div>
          <div class="chart-wrapper">
            <canvas #chartCanvas1 id="chart1" baseChart [data]="chartData1" [type]="chartType1"
              [options]="chartType1 === 'bar' ? barChartOptions : (chartType1 === 'pie' || chartType1 === 'doughnut') ? pieChartOptions : lineChartOptions"></canvas>
          </div>
        </div>

        <!-- Gráfica 2: Estado de crisis -->
        <div class="chart-container">
          <div class="chart-header">
            <h3>
              <mat-icon>warning</mat-icon>
              Estado de Crisis
            </h3>
            <button mat-icon-button [matMenuTriggerFor]="chartMenu2">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #chartMenu2="matMenu">
              <button mat-menu-item (click)="downloadChart(2)">
                <mat-icon>download</mat-icon>
                Descargar imagen
              </button>
              <button mat-menu-item (click)="toggleChartType(2)">
                <mat-icon>swap_horiz</mat-icon>
                Cambiar tipo ({{ chartType2 }})
              </button>
            </mat-menu>
          </div>
          <div class="chart-wrapper">
            <canvas #chartCanvas2 id="chart2" baseChart [data]="chartData2" [type]="chartType2"
              [options]="chartType2 === 'pie' || chartType2 === 'doughnut' ? pieChartOptions : (chartType2 === 'bar' ? barChartOptions : lineChartOptions)"></canvas>
          </div>
        </div>

        <!-- Gráfica 3: Ciudades principales -->
        <div class="chart-container">
          <div class="chart-header">
            <h3>
              <mat-icon>location_city</mat-icon>
              Ciudades Principales
            </h3>
            <button mat-icon-button [matMenuTriggerFor]="chartMenu3">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #chartMenu3="matMenu">
              <button mat-menu-item (click)="downloadChart(3)">
                <mat-icon>download</mat-icon>
                Descargar imagen
              </button>
              <button mat-menu-item (click)="toggleChartType(3)">
                <mat-icon>swap_horiz</mat-icon>
                Cambiar tipo ({{ chartType3 }})
              </button>
            </mat-menu>
          </div>
          <div class="chart-wrapper">
            <canvas #chartCanvas3 id="chart3" baseChart [data]="chartData3" [type]="chartType3"
              [options]="chartType3 === 'bar' ? barChartOptions : (chartType3 === 'pie' || chartType3 === 'doughnut' ? pieChartOptions : lineChartOptions)"></canvas>
          </div>
        </div>

        <!-- Gráfica 4: Nivel educativo -->
        <div class="chart-container">
          <div class="chart-header">
            <h3>
              <mat-icon>school</mat-icon>
              Nivel Educativo
            </h3>
            <button mat-icon-button [matMenuTriggerFor]="chartMenu4">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #chartMenu4="matMenu">
              <button mat-menu-item (click)="downloadChart(4)">
                <mat-icon>download</mat-icon>
                Descargar imagen
              </button>
              <button mat-menu-item (click)="toggleChartType(4)">
                <mat-icon>swap_horiz</mat-icon>
                Cambiar tipo ({{ chartType4 }})
              </button>
            </mat-menu>
          </div>
          <div class="chart-wrapper">
            <canvas #chartCanvas4 id="chart4" baseChart [data]="chartData4" [type]="chartType4"
              [options]="chartType4 === 'pie' || chartType4 === 'doughnut' ? pieChartOptions : (chartType4 === 'bar' ? barChartOptions : lineChartOptions)"></canvas>
          </div>
        </div>

                <div class="chart-container">
          <div class="chart-header">
            <h3>
              <mat-icon>cake</mat-icon>
              Distribución por Edad
            </h3>
            <button mat-icon-button [matMenuTriggerFor]="chartMenu6">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #chartMenu6="matMenu">
              <button mat-menu-item (click)="downloadChart(6)">
                <mat-icon>download</mat-icon>
                Descargar imagen
              </button>
              <button mat-menu-item (click)="toggleChartType(6)">
                <mat-icon>swap_horiz</mat-icon>
                Cambiar tipo ({{ chartType6 }})
              </button>
            </mat-menu>
          </div>
          <div class="chart-wrapper">
            <canvas #chartCanvas6 id="chart6" baseChart [data]="chartData6" [type]="chartType6"
              [options]="chartType6 === 'bar' ? barChartOptions : (chartType6 === 'pie' || chartType6 === 'doughnut' ? pieChartOptions : lineChartOptions)"></canvas>
          </div>
        </div>

        <!-- Gráfica 5: Evolución temporal -->
        <div class="chart-container full-width">
          <div class="chart-header">
            <h3>
              <mat-icon>timeline</mat-icon>
              Evolución de Registros
            </h3>
            <button mat-icon-button [matMenuTriggerFor]="chartMenu5">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #chartMenu5="matMenu">
              <button mat-menu-item (click)="downloadChart(5)">
                <mat-icon>download</mat-icon>
                Descargar imagen
              </button>
            </mat-menu>
          </div>
          <div class="chart-wrapper">
            <canvas #chartCanvas5 id="chart5" baseChart [data]="chartData5" [type]="chartType5"
              [options]="lineChartOptions"></canvas>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Diálogo para rango personalizado -->
  <ng-template #customRangeDialog>
    <h2 mat-dialog-title>Seleccionar rango personalizado</h2>
    <mat-dialog-content>
      <div class="date-range-picker">
        <mat-form-field>
          <mat-label>Fecha de inicio</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="customRangeStart">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field>
          <mat-label>Fecha de fin</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="customRangeEnd">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </mat-dialog-content>
    <mat-dialog-actions>
      <button mat-button mat-dialog-close>Cancelar</button>
      <button mat-raised-button color="primary" [mat-dialog-close]="true" (click)="applyCustomRange()"
        [disabled]="!customRangeStart || !customRangeEnd">
        Aplicar
      </button>
    </mat-dialog-actions>
  </ng-template>
</div>